<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Week 6 Lab: Time Series Decomposition and Forecasting</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="lab_01_week_02_files/libs/clipboard/clipboard.min.js"></script>
<script src="lab_01_week_02_files/libs/quarto-html/quarto.js"></script>
<script src="lab_01_week_02_files/libs/quarto-html/popper.min.js"></script>
<script src="lab_01_week_02_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="lab_01_week_02_files/libs/quarto-html/anchor.min.js"></script>
<link href="lab_01_week_02_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="lab_01_week_02_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="lab_01_week_02_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="lab_01_week_02_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="lab_01_week_02_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#learning-objectives-r" id="toc-learning-objectives-r" class="nav-link active" data-scroll-target="#learning-objectives-r">Learning Objectives R</a></li>
  <li><a href="#learning-objectives-tableau" id="toc-learning-objectives-tableau" class="nav-link" data-scroll-target="#learning-objectives-tableau">Learning Objectives Tableau</a></li>
  <li><a href="#r-time-series-decomposition" id="toc-r-time-series-decomposition" class="nav-link" data-scroll-target="#r-time-series-decomposition">R: Time Series Decomposition</a>
  <ul class="collapse">
  <li><a href="#step-1-load-your-data" id="toc-step-1-load-your-data" class="nav-link" data-scroll-target="#step-1-load-your-data">Step 1: Load your data</a></li>
  <li><a href="#step-2-convert-your-data-into-a-time-series-object" id="toc-step-2-convert-your-data-into-a-time-series-object" class="nav-link" data-scroll-target="#step-2-convert-your-data-into-a-time-series-object">Step 2: Convert your data into a time series object</a></li>
  <li><a href="#step-3-decompose-your-time-series-data" id="toc-step-3-decompose-your-time-series-data" class="nav-link" data-scroll-target="#step-3-decompose-your-time-series-data">Step 3: Decompose your time series data</a></li>
  <li><a href="#step-4-examine-the-results-of-the-decomposition" id="toc-step-4-examine-the-results-of-the-decomposition" class="nav-link" data-scroll-target="#step-4-examine-the-results-of-the-decomposition">Step 4: Examine the results of the decomposition</a></li>
  <li><a href="#step-5-store-the-decomposed-data-in-a-data-frame" id="toc-step-5-store-the-decomposed-data-in-a-data-frame" class="nav-link" data-scroll-target="#step-5-store-the-decomposed-data-in-a-data-frame">Step 5: Store the Decomposed Data in a Data Frame</a></li>
  </ul></li>
  <li><a href="#r-forecasting" id="toc-r-forecasting" class="nav-link" data-scroll-target="#r-forecasting">R: Forecasting</a>
  <ul class="collapse">
  <li><a href="#step-1-extract-the-trend-seasonal-and-residual-components" id="toc-step-1-extract-the-trend-seasonal-and-residual-components" class="nav-link" data-scroll-target="#step-1-extract-the-trend-seasonal-and-residual-components">Step 1: Extract the trend, seasonal, and residual components</a></li>
  <li><a href="#step-2-forecast-the-trend-seasonal-and-residual-components" id="toc-step-2-forecast-the-trend-seasonal-and-residual-components" class="nav-link" data-scroll-target="#step-2-forecast-the-trend-seasonal-and-residual-components">Step 2: Forecast the trend, seasonal, and residual components</a></li>
  <li><a href="#step-3-combine-the-forecasted-components-to-obtain-the-final-forecast" id="toc-step-3-combine-the-forecasted-components-to-obtain-the-final-forecast" class="nav-link" data-scroll-target="#step-3-combine-the-forecasted-components-to-obtain-the-final-forecast">Step 3: Combine the forecasted components to obtain the final forecast</a></li>
  <li><a href="#step-4-merge-forecasted-data-with-observed-data" id="toc-step-4-merge-forecasted-data-with-observed-data" class="nav-link" data-scroll-target="#step-4-merge-forecasted-data-with-observed-data">Step 4: Merge Forecasted Data with Observed Data</a></li>
  <li><a href="#step-5-export-data-for-tableau" id="toc-step-5-export-data-for-tableau" class="nav-link" data-scroll-target="#step-5-export-data-for-tableau">Step 5: Export Data for Tableau</a></li>
  </ul></li>
  <li><a href="#tableau" id="toc-tableau" class="nav-link" data-scroll-target="#tableau">Tableau</a>
  <ul class="collapse">
  <li><a href="#step-1-connect-your-data-in-tableau" id="toc-step-1-connect-your-data-in-tableau" class="nav-link" data-scroll-target="#step-1-connect-your-data-in-tableau">Step 1: Connect Your Data in Tableau</a></li>
  <li><a href="#step-2-visualizing-time-series-decomposition" id="toc-step-2-visualizing-time-series-decomposition" class="nav-link" data-scroll-target="#step-2-visualizing-time-series-decomposition">Step 2: Visualizing Time Series Decomposition</a></li>
  <li><a href="#step-3-forecasting-in-tableau" id="toc-step-3-forecasting-in-tableau" class="nav-link" data-scroll-target="#step-3-forecasting-in-tableau">Step 3: Forecasting in Tableau</a></li>
  <li><a href="#step-4-compare-tableaus-forecast-with-rs-forecast" id="toc-step-4-compare-tableaus-forecast-with-rs-forecast" class="nav-link" data-scroll-target="#step-4-compare-tableaus-forecast-with-rs-forecast">Step 4: Compare Tableau’s forecast with R’s forecast</a></li>
  <li><a href="#step-5-identifying-seasonal-trends" id="toc-step-5-identifying-seasonal-trends" class="nav-link" data-scroll-target="#step-5-identifying-seasonal-trends">Step 5: Identifying Seasonal Trends</a></li>
  <li><a href="#final-step-publish-to-tableau-public" id="toc-final-step-publish-to-tableau-public" class="nav-link" data-scroll-target="#final-step-publish-to-tableau-public">Final Step: Publish to Tableau Public</a></li>
  </ul></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Week 6 Lab: Time Series Decomposition and Forecasting</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p><img src="includes/generic_forecasting.webp" class="img-fluid"></p>
<div style="font-size: 1.5em">
<p>This Lab Contributes to Course Objectives: 1, 2, 3, 4, 7, 8</p>
</div>
<section id="learning-objectives-r" class="level2">
<h2 class="anchored" data-anchor-id="learning-objectives-r">Learning Objectives R</h2>
<ul>
<li><p>Understand time series decomposition in R</p></li>
<li><p>Understand the steps of forecasting using a decomposition in R</p></li>
</ul>
</section>
<section id="learning-objectives-tableau" class="level2">
<h2 class="anchored" data-anchor-id="learning-objectives-tableau">Learning Objectives Tableau</h2>
<ul>
<li>Visualize decompositions and forecasts created in R</li>
</ul>
<!-- - Apply Tableau's default forecasting -->
<!-- - Customize Tableau's forecasting -->
<!-- - Create advanced visualizations to demonstrate seasonality and overall trends in time series data -->
<!---
## Unit 1 Project Overview
--->
</section>
<section id="r-time-series-decomposition" class="level1">
<h1>R: Time Series Decomposition</h1>
<section id="step-1-load-your-data" class="level3">
<h3 class="anchored" data-anchor-id="step-1-load-your-data">Step 1: Load your data</h3>
<p>First, set up your script (description, working directory, load packages).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># This is the script for lab 06.</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">setwd</span>(<span class="st">"Set your working directory"</span>)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Comment out the following line if you have already installed the forecast package.</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">"forecast"</span>)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Load necessary libraries</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyquant)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readr)</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(forecast)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then, load your time series data into R.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Retrieve time series data</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>carrot <span class="ot">&lt;-</span> <span class="fu">tq_get</span>(<span class="fu">c</span>(<span class="st">"WPU01130212"</span>),</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>                 <span class="at">get =</span> <span class="st">"economic.data"</span>,</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>                 <span class="at">from=</span><span class="st">"2007-08-01"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-2-convert-your-data-into-a-time-series-object" class="level3">
<h3 class="anchored" data-anchor-id="step-2-convert-your-data-into-a-time-series-object">Step 2: Convert your data into a time series object</h3>
<p>Next, convert your data into a time series object that R can work with. To do this, you can use the <code>ts()</code> function in R.</p>
<div class="callout callout-style-default callout-note callout-titled" title="Understanding `ts()` Syntax">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Understanding <code>ts()</code> Syntax
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>The <code>ts()</code> function is used to create time series objects in R, which allow for time-based analysis and modeling.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert data into a time series object</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>ts_object <span class="ot">&lt;-</span> <span class="fu">ts</span>(data, </span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>                <span class="at">start =</span> <span class="fu">c</span>(year, period), </span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>                <span class="at">frequency =</span> freq)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li><code>data</code> <span class="math inline">\(\rightarrow\)</span> The numeric vector containing time series values.</li>
<li><code>start</code> <span class="math inline">\(\rightarrow\)</span> The <strong>start time</strong> of the series, defined as <code>c(year, period)</code> where <code>period</code> represents the sub-time unit (e.g., month, quarter).</li>
<li><code>frequency</code> <span class="math inline">\(\rightarrow\)</span> Specifies the number of observations per unit of time:
<ul>
<li><code>12</code> for <strong>monthly</strong> data (12 months per year).</li>
<li><code>4</code> for <strong>quarterly</strong> data (4 quarters per year).</li>
<li><code>1</code> for <strong>annual</strong> data (1 observation per year).</li>
</ul></li>
<li><code>ts_object</code> <span class="math inline">\(\rightarrow\)</span> The resulting time series object that can be analyzed and decomposed.</li>
</ul>
</div>
</div>
</div>
<p>The <code>ts()</code> function takes three arguments: <code>data</code>, <code>start</code>, and <code>frequency.</code></p>
<ul>
<li><code>data</code> is a vector or matrix of your time series data,<br>
</li>
<li><code>start</code> is the start time of the series, and</li>
<li><code>frequency</code> is the number of observations per unit time (e.g., the number of observations per year, per month, etc.).</li>
</ul>
<p>In the case of the carrots dataset, the frequency is 12 (since there are 12 observations per year).</p>
<p>To convert the <code>carrot</code> dataset into a time series object, run the following command:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert to time series object</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>carrot_ts <span class="ot">&lt;-</span> <span class="fu">ts</span>(carrot<span class="sc">$</span>price,</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>                <span class="at">start=</span><span class="fu">c</span>(<span class="dv">2007</span>,<span class="dv">8</span>),</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>                <span class="at">frequency =</span> <span class="dv">12</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This will create a new time series object called <code>carrot_ts.</code></p>
</section>
<section id="step-3-decompose-your-time-series-data" class="level3">
<h3 class="anchored" data-anchor-id="step-3-decompose-your-time-series-data">Step 3: Decompose your time series data</h3>
<p>Now that you have your time series data in a format that R can work with, use the <code>decompose()</code> function to decompose it into its underlying components.</p>
<div class="callout callout-style-default callout-note callout-titled" title="Understanding `decompose()` Syntax">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-2-contents" aria-controls="callout-2" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Understanding <code>decompose()</code> Syntax
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-2" class="callout-2-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>The <code>decompose()</code> function is used to break down a time series into its trend, seasonal, and residual components.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>decomposed_ts <span class="ot">&lt;-</span> <span class="fu">decompose</span>(ts_object, <span class="at">type =</span> <span class="st">"additive"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li><code>ts_object</code> <span class="math inline">\(\rightarrow\)</span> A time series object created using <code>ts()</code>.</li>
<li><code>type</code> <span class="math inline">\(\rightarrow\)</span> Specifies whether the decomposition should be:
<ul>
<li><strong>“additive”</strong> if seasonal variations remain constant over time (the default if not specified).</li>
<li><strong>“multiplicative”</strong> if seasonal variations scale with the trend level.</li>
</ul></li>
<li><code>decomposed_ts</code> <span class="math inline">\(\rightarrow\)</span> The resulting decomposed time series object containing trend, seasonal, and residual components.</li>
</ul>
</div>
</div>
</div>
<p>The <code>decompose()</code> function takes one argument: <code>x</code>, which is the time series object you want to decompose.</p>
<p>To decompose the <code>carrot_ts</code> time series object, run the following command:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Perform time series decomposition</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>carrot_decomp <span class="ot">&lt;-</span> <span class="fu">decompose</span>(carrot_ts)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This will create a new object called <code>carrot_decomp</code> that contains the decomposed components of the <code>carrot_ts</code> time series object.</p>
<div class="callout callout-style-default callout-note callout-titled" title="Creating a Seasonally Adjusted Price in R">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Creating a Seasonally Adjusted Price in R
</div>
</div>
<div class="callout-body-container callout-body">
<p>After using the <code>decompose()</code> function, you can extract the seasonal component and subtract it from the original price series to obtain the <strong>seasonally adjusted price</strong>.</p>
<blockquote class="blockquote">
<p>Seasonally adjusted prices are prices that have had their seasonal component removed, allowing us to better observe underlying trends and long-term changes without regular fluctuations.</p>
</blockquote>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute seasonally adjusted price</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>carrot_sa_price <span class="ot">&lt;-</span> carrot_ts <span class="sc">-</span> carrot_decomp<span class="sc">$</span>seasonal</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(sa_plot)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="lab_01_week_02_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p><strong>Why Do We Use Seasonally Adjusted Prices?</strong></p>
<ul>
<li>Removes regular seasonal patterns to better observe long-term trends.</li>
<li>Helps in forecasting by isolating the trend and residual components.</li>
<li>Useful for economic and business analysis, where seasonal cycles might mask underlying changes.</li>
</ul>
<p>Now, the <code>sa_price</code> column represents the seasonally adjusted price, which can be visualized in Tableau or used in further analysis.</p>
</div>
</div>
</section>
<section id="step-4-examine-the-results-of-the-decomposition" class="level3">
<h3 class="anchored" data-anchor-id="step-4-examine-the-results-of-the-decomposition">Step 4: Examine the results of the decomposition</h3>
<p>Finally, examine the results of the time series decomposition by plotting the decomposed components. The <code>carrot_decomp</code> object contains four components:</p>
<ol type="1">
<li><code>trend</code></li>
<li><code>seasonal</code></li>
<li><code>random</code></li>
<li><code>figure</code></li>
</ol>
<p>You can access each of these components using the <code>$</code> operator.</p>
<p>To plot the decomposed components, run the following command:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(carrot_decomp<span class="sc">$</span>trend)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(carrot_decomp<span class="sc">$</span>seasonal)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(carrot_decomp<span class="sc">$</span>random)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This will create three separate plots that show the trend, seasonal, and random components of the time series data. You can use these plots to better understand the underlying patterns in your data.</p>
</section>
<section id="step-5-store-the-decomposed-data-in-a-data-frame" class="level3">
<h3 class="anchored" data-anchor-id="step-5-store-the-decomposed-data-in-a-data-frame">Step 5: Store the Decomposed Data in a Data Frame</h3>
<p>To work with the decomposed time series components in further analysis or visualization, we need to store them in a structured dataframe. This allows us to manipulate, export, and integrate the data into other tools like Tableau.</p>
<p>Let’s extract the first four components of the decomposition output and format them into a tidy dataframe:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>carrot_decomp_out <span class="ot">&lt;-</span> carrot_decomp[<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>] <span class="sc">%&gt;%</span> <span class="co"># Extract the first four components of the decomposition output</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span>            <span class="co"># Convert to a tibble for better readability</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">price =</span> x) <span class="sc">%&gt;%</span>      <span class="co"># Rename 'x' to 'price' for clarity</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">measure_date =</span> carrot<span class="sc">$</span>date,  <span class="co"># Add a measure_date column from the original dataset</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">forecast =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span>        <span class="co"># Add a column to indicate actual vs. forecasted data</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">drop_na</span>()                  <span class="co"># Remove any rows with missing values</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled" title="How does `mutate(measure_date = carrot$date)` work without a join?">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
How does <code>mutate(measure_date = carrot$date)</code> work without a join?
</div>
</div>
<div class="callout-body-container callout-body">
<p>This works due to <strong>positional matching</strong>:</p>
<ul>
<li><strong><code>carrot_decomp[1:4]</code></strong> keeps the same row order as <code>carrot_ts</code>, which was built from <code>carrot$price</code>.</li>
<li><strong><code>carrot$date</code></strong> retains the original timestamps, allowing direct assignment <strong>row by row</strong> in <code>mutate()</code>.</li>
<li>Since lengths align, <code>measure_date</code> correctly maps to each observation.</li>
</ul>
<p><strong>Potential issue:</strong> If missing values disrupt alignment, incorrect dates may be assigned. <code>drop_na()</code> helps prevent this.</p>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled" title="Check Your Understanding">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Check Your Understanding
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>What data type is the variable <code>measure_date</code> in the new data frame?</li>
</ol>
<blockquote class="blockquote">
<p>The data type of measure_date depends on how it was stored in the original dataset (<code>carrot$date</code>). You can check the data type by running:</p>
</blockquote>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(carrot_decomp_out)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<blockquote class="blockquote">
<p>If <code>measure_date</code> was originally read in as a character (chr), it will remain a character in the new dataframe. Otherwise, it may already be recognized as a Date object.</p>
</blockquote>
<ol start="2" type="1">
<li>If <code>measure_date</code> is stored as a character (chr) instead of a date, which function would you use to convert it to a proper date format?</li>
</ol>
<blockquote class="blockquote">
<p>You can use the <code>as.Date()</code> function from base R or either the <code>ymd()</code> function from the lubridate package.</p>
</blockquote>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>carrot_decomp_out <span class="ot">&lt;-</span> carrot_decomp_out <span class="sc">%&gt;%</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">measure_date =</span> <span class="fu">ymd</span>(measure_date))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<blockquote class="blockquote">
<p>If your date format is different (e.g., “MM/DD/YYYY”), use <code>mdy(measure_date)</code> or <code>dmy(measure_date)</code> accordingly.</p>
</blockquote>
<ol start="3" type="1">
<li>Why is it important to remove missing values <code>drop_na()</code> in time series analysis?</li>
</ol>
<blockquote class="blockquote">
<p>Missing values can disrupt time series analysis and forecasting models, leading to inaccurate results.Many time series functions in R, such as <code>forecast()</code> or <code>decompose()</code>, require complete time series data to function correctly. Removing missing values ensures that the trend, seasonal, and residual components are correctly estimated without gaps in the data.</p>
</blockquote>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled" title="Recall: Tibbles vs. Data Frames">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Recall: Tibbles vs.&nbsp;Data Frames
</div>
</div>
<div class="callout-body-container callout-body">
<p>Go back to the <a href="https://csu-arec-330.github.io/materials/unit_00/week_03/lab_00_week_03.html#read-the-data-into-r">Lab Notes for Week 3</a> to review the differences between a data frame and a tibble.</p>
</div>
</div>
</section>
</section>
<section id="r-forecasting" class="level1">
<h1>R: Forecasting</h1>
<p>Forecasting allows us to extend our time series into the future by predicting trends, seasonal patterns, and random fluctuations. We will build our forecast by separately modeling the trend, seasonality, and residual (random) components extracted from the decomposition.</p>
<p>Before proceeding with forecasting in R, make sure that the <code>forecast</code> package is loaded.</p>
<section id="step-1-extract-the-trend-seasonal-and-residual-components" class="level3">
<h3 class="anchored" data-anchor-id="step-1-extract-the-trend-seasonal-and-residual-components">Step 1: Extract the trend, seasonal, and residual components</h3>
<p>The <code>decompose()</code> function breaks a time series into three key components:</p>
<ol type="1">
<li>Trend: The long-term upward or downward movement in the data.</li>
<li>Seasonality: The repeating patterns at fixed intervals (e.g., monthly, quarterly).</li>
<li>Residual (Random Noise): The part of the time series that is unexplained after removing the trend and seasonality.</li>
</ol>
<p>We extract these components from the decomposition object using the <code>$</code> operator and remove any missing values with <code>na.omit()</code>.</p>
<div class="callout callout-style-default callout-note callout-titled" title="Understanding na.omit() Syntax">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-7-contents" aria-controls="callout-7" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Understanding na.omit() Syntax
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-7" class="callout-7-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>The <code>na.omit()</code> function removes missing values (NAs) from a dataset or vector. This is especially useful in time series analysis, where missing values can interfere with forecasting models.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>clean_data <span class="ot">&lt;-</span> <span class="fu">na.omit</span>(original_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>original_data <span class="math inline">\(\rightarrow\)</span> The vector, dataframe, or time series from which to remove missing values.</li>
<li>clean_data <span class="math inline">\(\rightarrow\)</span> The resulting dataset with all NAs removed.</li>
</ul>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract the trend, seasonal, and residual components</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>carrot_trend <span class="ot">&lt;-</span> <span class="fu">na.omit</span>(carrot_decomp<span class="sc">$</span>trend) <span class="co"># Extract trend component and remove NAs</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>carrot_seasonal <span class="ot">&lt;-</span> <span class="fu">na.omit</span>(carrot_decomp<span class="sc">$</span>seasonal)[<span class="dv">7</span><span class="sc">:</span>(<span class="fu">length</span>(carrot_ts)<span class="sc">-</span><span class="dv">6</span>)] <span class="sc">%&gt;%</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ts</span>(.,<span class="at">start =</span> <span class="fu">c</span>(<span class="dv">2008</span>,<span class="dv">2</span>), <span class="at">frequency =</span> <span class="dv">12</span>) <span class="co"># Extract and convert seasonality into a time series</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>carrot_residuals <span class="ot">&lt;-</span> <span class="fu">na.omit</span>(carrot_decomp<span class="sc">$</span>random) <span class="co"># Extract residual component and remove NAs</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>Why Remove Missing Values?</strong></p>
<ul>
<li>Missing values can cause errors in forecasting models that require a continuous time series.</li>
<li>Functions like <code>forecast()</code> and <code>arima()</code> do not work well with missing values.</li>
<li>Removing NAs ensures that only complete data is used for trend, seasonal, and residual modeling.</li>
</ul>
<p>Now that we have extracted and cleaned these components, we are ready to forecast each one separately in the next step.</p>
</section>
<section id="step-2-forecast-the-trend-seasonal-and-residual-components" class="level3">
<h3 class="anchored" data-anchor-id="step-2-forecast-the-trend-seasonal-and-residual-components">Step 2: Forecast the trend, seasonal, and residual components</h3>
<p>To forecast each component, we use the <code>forecast()</code> function from the <code>forecast</code> package in R.</p>
<div class="callout callout-style-default callout-note callout-titled" title="Understanding `forecast()` Syntax">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-8-contents" aria-controls="callout-8" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Understanding <code>forecast()</code> Syntax
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-8" class="callout-8-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>The <code>forecast()</code> function is used to generate future values of a time series based on past observations and trends.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>forecasted_ts <span class="ot">&lt;-</span> <span class="fu">forecast</span>(model_or_ts, <span class="at">h =</span> forecast_horizon, <span class="at">level =</span> confidence_interval)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li><code>model_or_ts</code> <span class="math inline">\(\rightarrow\)</span> A time series object or fitted model (such as ARIMA or ETS) used for forecasting.</li>
<li><code>h</code> <span class="math inline">\(\rightarrow\)</span> The number of future periods to forecast (e.g., <code>h = 12</code> for 12 months ahead).</li>
<li><code>level</code> <span class="math inline">\(\rightarrow\)</span> The confidence level for the prediction intervals (e.g., <code>level = 95</code> for 95% confidence intervals).</li>
<li><code>forecasted_ts</code> <span class="math inline">\(\rightarrow\)</span> The resulting forecast object containing predicted values, confidence intervals, and model details.</li>
</ul>
</div>
</div>
</div>
<section id="forecasting-trend-and-seasonal-components" class="level4">
<h4 class="anchored" data-anchor-id="forecasting-trend-and-seasonal-components">Forecasting Trend and Seasonal Components</h4>
<p>To project future values, we use the <code>forecast()</code> function on the trend and seasonal components separately.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Forecast the trend component for the next 12 months</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>carrot_trend_forecast <span class="ot">&lt;-</span> <span class="fu">forecast</span>(carrot_trend, <span class="at">level =</span> <span class="dv">95</span>, <span class="at">h =</span> <span class="dv">60</span>)</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(carrot_trend_forecast)</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Forecast the seasonal component for the next 12 months</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>carrot_seasonal_forecast <span class="ot">&lt;-</span> <span class="fu">forecast</span>(carrot_seasonal, <span class="at">level =</span> <span class="dv">95</span>, <span class="at">h =</span> <span class="dv">60</span>)</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(carrot_seasonal_forecast)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<blockquote class="blockquote">
<p>Check your output: Did you get a warning? If so, what does the warning message indicate? This may be due to <code>decompose()</code> treating seasonality as a deterministic component, meaning it assumes seasonality repeats exactly. Since there’s no inherent randomness, confidence intervals may not be meaningful.</p>
</blockquote>
</section>
<section id="forecasting-residuals" class="level4">
<h4 class="anchored" data-anchor-id="forecasting-residuals">Forecasting Residuals</h4>
<p>The residual component captures the random variation left after accounting for trend and seasonality. Unlike trend and seasonal components, residuals require a statistical model to forecast. One common approach is to use a <strong>Moving Average (MA) model</strong>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a time series object for the residuals</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>carrot_residuals_ts <span class="ot">&lt;-</span> <span class="fu">ts</span>(carrot_residuals, <span class="at">frequency=</span><span class="dv">12</span>, <span class="at">start =</span> <span class="fu">c</span>(<span class="dv">2007</span>, <span class="dv">8</span>))</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit an MA(1) model to the residuals</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>carrot_residuals_model <span class="ot">&lt;-</span> <span class="fu">arima</span>(carrot_residuals_ts, <span class="at">order =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">1</span>))</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Forecast the residuals for the next 12 months</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>carrot_residuals_forecast <span class="ot">&lt;-</span> <span class="fu">forecast</span>(carrot_residuals_model, <span class="at">level =</span> <span class="dv">95</span>, <span class="at">h =</span> <span class="dv">60</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<blockquote class="blockquote">
<p>Why do we model the residuals separately? Unlike the trend and seasonal components, the residuals are unpredictable and must be modeled probabilistically rather than simply extended forward.</p>
</blockquote>
<div class="callout callout-style-default callout-note callout-titled" title="Understanding `arima()` Syntax">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-9-contents" aria-controls="callout-9" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Understanding <code>arima()</code> Syntax
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-9" class="callout-9-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>The <code>arima()</code> function fits an <strong>Autoregressive Integrated Moving Average (ARIMA)</strong> model to a time series for forecasting.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">arima</span>(ts_object, <span class="at">order =</span> <span class="fu">c</span>(p, d, q))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li><code>ts_object</code> <span class="math inline">\(\rightarrow\)</span> The time series data.</li>
<li><code>order = c(p, d, q)</code>:
<ul>
<li><code>p</code> (autoregressive order) <span class="math inline">\(\rightarrow\)</span> Number of lagged observations used as predictors.</li>
<li><code>d</code> (differencing order) <span class="math inline">\(\rightarrow\)</span> Number of times the data is differenced to make it stationary.</li>
<li><code>q</code> (moving average order) <span class="math inline">\(\rightarrow\)</span> Number of past forecast errors used in the model.</li>
</ul></li>
</ul>
<p>Example: Fit an ARIMA(1,0,1) model (AR(1) + MA(1)) to a time series:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>carrot_arima <span class="ot">&lt;-</span> <span class="fu">arima</span>(carrot_ts, <span class="at">order =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This model uses one lagged value and one past error term to make predictions.</p>
</div>
</div>
</div>
<p><strong>This approach ensures that our final forecast accounts for all key components of the time series: trend, seasonality, and random variation.</strong></p>
</section>
</section>
<section id="step-3-combine-the-forecasted-components-to-obtain-the-final-forecast" class="level3">
<h3 class="anchored" data-anchor-id="step-3-combine-the-forecasted-components-to-obtain-the-final-forecast">Step 3: Combine the forecasted components to obtain the final forecast</h3>
<p>Now that we have separate forecasts for the trend, seasonal, and residual components, we need to combine them to generate the final forecasted values for the time series.</p>
<section id="compute-the-final-forecast" class="level4">
<h4 class="anchored" data-anchor-id="compute-the-final-forecast">1. Compute the Final Forecast</h4>
<p>The final forecast is the sum of the forecasted trend, seasonal, and residual components.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine the forecasted components to obtain the final forecast</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>carrot_forecast <span class="ot">&lt;-</span> carrot_trend_forecast<span class="sc">$</span>mean <span class="sc">+</span> </span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>                    carrot_seasonal_forecast<span class="sc">$</span>mean <span class="sc">+</span> </span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>                    carrot_residuals_forecast<span class="sc">$</span>mean</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a><span class="fu">View</span>(carrot_forecast)</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute upper bound for confidence interval</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>carrot_forecast_upper <span class="ot">&lt;-</span> carrot_trend_forecast<span class="sc">$</span>upper <span class="sc">+</span> </span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>                          carrot_seasonal_forecast<span class="sc">$</span>upper <span class="sc">+</span> </span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>                          carrot_residuals_forecast<span class="sc">$</span>upper</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a><span class="fu">View</span>(carrot_forecast_upper)</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute lower bound for confidence interval</span></span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>carrot_forecast_lower <span class="ot">&lt;-</span> carrot_trend_forecast<span class="sc">$</span>lower <span class="sc">+</span> </span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>                          carrot_seasonal_forecast<span class="sc">$</span>lower <span class="sc">+</span> </span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>                          carrot_residuals_forecast<span class="sc">$</span>lower</span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a><span class="fu">View</span>(carrot_forecast_lower)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>At this point, <code>carrot_forecast</code> contains the predicted future values, while <code>carrot_forecast_upper</code> and <code>carrot_forecast_lower</code> provide confidence intervals around those predictions.</p>
</section>
<section id="convert-forecasted-values-into-a-data-frame" class="level4">
<h4 class="anchored" data-anchor-id="convert-forecasted-values-into-a-data-frame">2. Convert Forecasted Values into a Data Frame</h4>
<p>Since <code>forecast()</code> returns a special object, we need to convert the results into a standard data frame (a tibble in this case) before merging it with the original dataset.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert forecasted values into a tibble with corresponding dates</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>carrot_forecast_df <span class="ot">&lt;-</span> <span class="fu">tibble</span>( <span class="co"># Create a tibble (a modern dataframe in R)</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">price =</span> carrot_forecast, <span class="co"># Stores the forecasted price values</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">upper =</span> carrot_forecast_upper[,<span class="dv">1</span>], <span class="co"># Extracts the upper confidence interval for the forecast</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">lower =</span> carrot_forecast_lower[,<span class="dv">1</span>] <span class="co"># Extracts the lower confidence interval for the forecast</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">measure_date =</span> <span class="fu">seq</span>(<span class="fu">as_date</span>(<span class="st">"2023-08-01"</span>), <span class="at">by =</span> <span class="st">"months"</span>, <span class="at">length.out =</span> <span class="fu">nrow</span>(.))) <span class="co"># Add a variable called measure_date</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>What This Block of Code Does</strong></p>
<ul>
<li>The forecasted values from <code>forecast()</code> are not in a standard tabular format, so we need to reshape them.</li>
<li>We assign a corresponding date (<code>measure_date</code>) to each forecasted value, ensuring alignment with the original time series.</li>
<li>The confidence intervals (<code>upper</code> and <code>lower</code>) allow us to quantify forecast uncertainty.</li>
</ul>
<div class="callout callout-style-default callout-note callout-titled" title="Why is `[,1]` used in `carrot_forecast_upper[,1]` and `carrot_forecast_lower[,1]`?">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Why is <code>[,1]</code> used in <code>carrot_forecast_upper[,1]</code> and <code>carrot_forecast_lower[,1]</code>?
</div>
</div>
<div class="callout-body-container callout-body">
<p>The <code>forecast()</code> function returns <strong>confidence intervals as matrices</strong>, with each column representing different confidence levels (e.g., 80%, 95%).</p>
<p>However, if only <strong>one confidence level</strong> is specified in <code>forecast()</code>, the matrix will only contain <strong>one column</strong>.</p>
<section id="breakdown" class="level4">
<h4 class="anchored" data-anchor-id="breakdown">Breakdown:</h4>
<ul>
<li><code>forecast_object$upper</code> and <code>forecast_object$lower</code> are <strong>matrices</strong>, not vectors.</li>
<li>If <strong>one confidence level</strong> is specified (e.g., <code>level = 95</code>), the matrix will have only <strong>one column</strong>, and <code>[,1]</code> is required to extract the values.</li>
<li>If <strong>multiple confidence levels</strong> are specified (e.g., <code>level = c(80, 95)</code>), the matrix will have <strong>two columns</strong>, where <code>[,1]</code> corresponds to the 80% interval and <code>[,2]</code> corresponds to the 95% interval.</li>
</ul>
</section>
<section id="example-using-carrot_forecast" class="level4">
<h4 class="anchored" data-anchor-id="example-using-carrot_forecast">Example using <code>carrot_forecast</code>:</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Forecasting with a single confidence level (e.g., 95%)</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>carrot_trend_forecast <span class="ot">&lt;-</span> <span class="fu">forecast</span>(carrot_trend, <span class="at">level =</span> <span class="dv">95</span>, <span class="at">h =</span> <span class="dv">60</span>)</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Check the structure of the confidence interval matrix</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(carrot_trend_forecast<span class="sc">$</span>upper)  <span class="co"># Output: [1:60, 1] → 60 time steps, 1 confidence level</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract the only available confidence interval</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>carrot_forecast_upper <span class="ot">&lt;-</span> carrot_trend_forecast<span class="sc">$</span>upper[,<span class="dv">1</span>]  </span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>carrot_forecast_lower <span class="ot">&lt;-</span> carrot_trend_forecast<span class="sc">$</span>lower[,<span class="dv">1</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In this case, because we only specified one confidence level (<code>level = 95</code>), the output matrix has only one column, and <code>[,1]</code> is needed to extract the values.</p>
<p>If we had specified multiple levels (<code>level = c(80, 95)</code>), we would need to use <code>[,2]</code> to extract the 95% confidence interval.</p>
</section>
</div>
</div>
<p>At this stage, we have a clean forecast dataset that is ready to be appended to the existing observed data. The next step is to merge this with the original time series data and prepare it for visualization in Tableau.</p>
</section>
</section>
<section id="step-4-merge-forecasted-data-with-observed-data" class="level3">
<h3 class="anchored" data-anchor-id="step-4-merge-forecasted-data-with-observed-data">Step 4: Merge Forecasted Data with Observed Data</h3>
<p>Now that we have created our forecasted values, we need to append them to the original dataset. However, there is a slight complication:</p>
<ul>
<li>Some of the original observed data overlaps with the beginning of the forecasted period.</li>
<li>This occurs because some data points were lost during the decomposition process (e.g., due to moving averages used in decompose()).</li>
<li>We have three options for handling this overlap:
<ol type="1">
<li>Keep both the forecasted and observed data.</li>
<li>Keep only the forecasted values in the overlapping period.</li>
<li>Keep only the observed values in the overlapping period.</li>
</ol></li>
</ul>
<p>For this analysis, we will follow option #3 (keep only the observed values in the overlapping period) and append the remaining forecasted values to the dataset.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Keep only forecasted data that occurs after the last observed date</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>carrot_forecast_df <span class="ot">&lt;-</span> carrot_forecast_df <span class="sc">%&gt;%</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(measure_date <span class="sc">&gt;</span> <span class="fu">max</span>(carrot_decomp_out<span class="sc">$</span>measure_date)) <span class="sc">%&gt;%</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">forecast =</span> <span class="cn">TRUE</span>) <span class="co"># Mark these as forecasted values</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Append forecasted data to the original dataset</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>final_out <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(carrot_decomp_out,carrot_forecast_df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-5-export-data-for-tableau" class="level3">
<h3 class="anchored" data-anchor-id="step-5-export-data-for-tableau">Step 5: Export Data for Tableau</h3>
<p>To prepare for visualization in Tableau, we need to export the final dataset as a CSV file.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the final dataset as a CSV file</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="fu">write_csv</span>(final_out,<span class="st">"carrot_forecast.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This CSV file will contain:</p>
<ul>
<li>Original observed prices</li>
<li>Decomposed trend, seasonality, and residual components</li>
<li>Forecasted values for future months</li>
<li>A <strong>forecast</strong> indicator column to distinguish real vs.&nbsp;predicted data</li>
</ul>
<div class="callout callout-style-default callout-tip callout-titled" title="Lab Script for Week 6: Time Series Decomposition and Forecasting">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-11-contents" aria-controls="callout-11" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Lab Script for Week 6: Time Series Decomposition and Forecasting
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-11" class="callout-11-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># This is the script for lab 06.</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="fu">setwd</span>(<span class="st">"Set your working directory"</span>)</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Comment out the following line if you have already installed the forecast package.</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">"forecast"</span>)</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Load necessary libraries</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyquant)</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readr)</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(forecast)</span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Part 1: Time Series Decomposition</span></span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Retrieve time series data for carrots</span></span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a>carrot <span class="ot">&lt;-</span> <span class="fu">tq_get</span>(<span class="fu">c</span>(<span class="st">"WPU01130212"</span>),</span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a>                 <span class="at">get =</span> <span class="st">"economic.data"</span>,</span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a>                 <span class="at">from =</span> <span class="st">"2007-08-01"</span>)</span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert data into a time series object</span></span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a>carrot_ts <span class="ot">&lt;-</span> <span class="fu">ts</span>(carrot<span class="sc">$</span>price,</span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a>                <span class="at">start =</span> <span class="fu">c</span>(<span class="dv">2007</span>,<span class="dv">8</span>),</span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a>                <span class="at">frequency =</span> <span class="dv">12</span>)</span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Decompose the time series</span></span>
<span id="cb25-30"><a href="#cb25-30" aria-hidden="true" tabindex="-1"></a>carrot_decomp <span class="ot">&lt;-</span> <span class="fu">decompose</span>(carrot_ts)</span>
<span id="cb25-31"><a href="#cb25-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-32"><a href="#cb25-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute seasonally adjusted price</span></span>
<span id="cb25-33"><a href="#cb25-33" aria-hidden="true" tabindex="-1"></a>carrot_sa_price <span class="ot">&lt;-</span> carrot_ts <span class="sc">-</span> carrot_decomp<span class="sc">$</span>seasonal</span>
<span id="cb25-34"><a href="#cb25-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-35"><a href="#cb25-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert to a tibble for easier handling</span></span>
<span id="cb25-36"><a href="#cb25-36" aria-hidden="true" tabindex="-1"></a>carrot_decomp_sa <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb25-37"><a href="#cb25-37" aria-hidden="true" tabindex="-1"></a>  <span class="at">measure_date =</span> carrot<span class="sc">$</span>date,</span>
<span id="cb25-38"><a href="#cb25-38" aria-hidden="true" tabindex="-1"></a>  <span class="at">price =</span> carrot<span class="sc">$</span>price,</span>
<span id="cb25-39"><a href="#cb25-39" aria-hidden="true" tabindex="-1"></a>  <span class="at">trend =</span> carrot_decomp<span class="sc">$</span>trend,</span>
<span id="cb25-40"><a href="#cb25-40" aria-hidden="true" tabindex="-1"></a>  <span class="at">seasonal =</span> carrot_decomp<span class="sc">$</span>seasonal,</span>
<span id="cb25-41"><a href="#cb25-41" aria-hidden="true" tabindex="-1"></a>  <span class="at">residual =</span> carrot_decomp<span class="sc">$</span>random,</span>
<span id="cb25-42"><a href="#cb25-42" aria-hidden="true" tabindex="-1"></a>  <span class="at">sa_price =</span> <span class="fu">as.numeric</span>(carrot_sa_price) <span class="co"># Seasonally adjusted price converted to numeric for plotting</span></span>
<span id="cb25-43"><a href="#cb25-43" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb25-44"><a href="#cb25-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">drop_na</span>()</span>
<span id="cb25-45"><a href="#cb25-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-46"><a href="#cb25-46" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot original prices vs. seasonally adjusted prices</span></span>
<span id="cb25-47"><a href="#cb25-47" aria-hidden="true" tabindex="-1"></a>sa_plot <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(carrot_decomp_sa, <span class="fu">aes</span>(<span class="at">x =</span> measure_date)) <span class="sc">+</span></span>
<span id="cb25-48"><a href="#cb25-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> price, <span class="at">color =</span> <span class="st">"Original Price"</span>), <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb25-49"><a href="#cb25-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> sa_price, <span class="at">color =</span> <span class="st">"Seasonally Adjusted Price"</span>), <span class="at">linewidth =</span> <span class="dv">1</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb25-50"><a href="#cb25-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Carrot Prices vs. Seasonally Adjusted Prices"</span>,</span>
<span id="cb25-51"><a href="#cb25-51" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Date"</span>, <span class="at">y =</span> <span class="st">"Price"</span>,</span>
<span id="cb25-52"><a href="#cb25-52" aria-hidden="true" tabindex="-1"></a>       <span class="at">color =</span> <span class="st">"Legend"</span>) <span class="sc">+</span></span>
<span id="cb25-53"><a href="#cb25-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb25-54"><a href="#cb25-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-55"><a href="#cb25-55" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(sa_plot)</span>
<span id="cb25-56"><a href="#cb25-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-57"><a href="#cb25-57" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot decomposed components</span></span>
<span id="cb25-58"><a href="#cb25-58" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(carrot_decomp<span class="sc">$</span>trend)</span>
<span id="cb25-59"><a href="#cb25-59" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(carrot_decomp<span class="sc">$</span>seasonal)</span>
<span id="cb25-60"><a href="#cb25-60" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(carrot_decomp<span class="sc">$</span>random)</span>
<span id="cb25-61"><a href="#cb25-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-62"><a href="#cb25-62" aria-hidden="true" tabindex="-1"></a><span class="co"># Store decomposition results into a dataframe</span></span>
<span id="cb25-63"><a href="#cb25-63" aria-hidden="true" tabindex="-1"></a>carrot_decomp_out <span class="ot">&lt;-</span> carrot_decomp[<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>] <span class="sc">%&gt;%</span></span>
<span id="cb25-64"><a href="#cb25-64" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span></span>
<span id="cb25-65"><a href="#cb25-65" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">price =</span> x) <span class="sc">%&gt;%</span></span>
<span id="cb25-66"><a href="#cb25-66" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">measure_date =</span> carrot<span class="sc">$</span>date,</span>
<span id="cb25-67"><a href="#cb25-67" aria-hidden="true" tabindex="-1"></a>         <span class="at">forecast =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb25-68"><a href="#cb25-68" aria-hidden="true" tabindex="-1"></a>  <span class="fu">drop_na</span>()</span>
<span id="cb25-69"><a href="#cb25-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-70"><a href="#cb25-70" aria-hidden="true" tabindex="-1"></a><span class="co"># Part 2: Forecasting</span></span>
<span id="cb25-71"><a href="#cb25-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-72"><a href="#cb25-72" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract trend, seasonal, and residual components</span></span>
<span id="cb25-73"><a href="#cb25-73" aria-hidden="true" tabindex="-1"></a>carrot_trend <span class="ot">&lt;-</span> <span class="fu">na.omit</span>(carrot_decomp<span class="sc">$</span>trend)</span>
<span id="cb25-74"><a href="#cb25-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-75"><a href="#cb25-75" aria-hidden="true" tabindex="-1"></a>carrot_seasonal <span class="ot">&lt;-</span> <span class="fu">na.omit</span>(carrot_decomp<span class="sc">$</span>seasonal)[<span class="dv">7</span><span class="sc">:</span>(<span class="fu">length</span>(carrot_ts) <span class="sc">-</span> <span class="dv">6</span>)] <span class="sc">%&gt;%</span></span>
<span id="cb25-76"><a href="#cb25-76" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ts</span>(., <span class="at">start =</span> <span class="fu">c</span>(<span class="dv">2008</span>, <span class="dv">2</span>), <span class="at">frequency =</span> <span class="dv">12</span>)</span>
<span id="cb25-77"><a href="#cb25-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-78"><a href="#cb25-78" aria-hidden="true" tabindex="-1"></a>carrot_residuals <span class="ot">&lt;-</span> <span class="fu">na.omit</span>(carrot_decomp<span class="sc">$</span>random)</span>
<span id="cb25-79"><a href="#cb25-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-80"><a href="#cb25-80" aria-hidden="true" tabindex="-1"></a><span class="co"># Forecast trend and seasonal components</span></span>
<span id="cb25-81"><a href="#cb25-81" aria-hidden="true" tabindex="-1"></a>carrot_trend_forecast <span class="ot">&lt;-</span> <span class="fu">forecast</span>(carrot_trend, <span class="at">level =</span> <span class="dv">95</span>, <span class="at">h =</span> <span class="dv">60</span>)</span>
<span id="cb25-82"><a href="#cb25-82" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(carrot_trend_forecast)</span>
<span id="cb25-83"><a href="#cb25-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-84"><a href="#cb25-84" aria-hidden="true" tabindex="-1"></a>carrot_seasonal_forecast <span class="ot">&lt;-</span> <span class="fu">forecast</span>(carrot_seasonal, <span class="at">level =</span> <span class="dv">95</span>, <span class="at">h =</span> <span class="dv">60</span>)</span>
<span id="cb25-85"><a href="#cb25-85" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(carrot_seasonal_forecast)</span>
<span id="cb25-86"><a href="#cb25-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-87"><a href="#cb25-87" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit an MA(1) model for residuals and forecast</span></span>
<span id="cb25-88"><a href="#cb25-88" aria-hidden="true" tabindex="-1"></a>carrot_residuals_ts <span class="ot">&lt;-</span> <span class="fu">ts</span>(carrot_residuals, <span class="at">frequency =</span> <span class="dv">12</span>, <span class="at">start =</span> <span class="fu">c</span>(<span class="dv">2007</span>, <span class="dv">8</span>))</span>
<span id="cb25-89"><a href="#cb25-89" aria-hidden="true" tabindex="-1"></a>carrot_residuals_model <span class="ot">&lt;-</span> <span class="fu">arima</span>(carrot_residuals_ts, <span class="at">order =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">1</span>))</span>
<span id="cb25-90"><a href="#cb25-90" aria-hidden="true" tabindex="-1"></a>carrot_residuals_forecast <span class="ot">&lt;-</span> <span class="fu">forecast</span>(carrot_residuals_model, <span class="at">level =</span> <span class="dv">95</span>, <span class="at">h =</span> <span class="dv">60</span>)</span>
<span id="cb25-91"><a href="#cb25-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-92"><a href="#cb25-92" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine forecasted components</span></span>
<span id="cb25-93"><a href="#cb25-93" aria-hidden="true" tabindex="-1"></a>carrot_forecast <span class="ot">&lt;-</span> carrot_trend_forecast<span class="sc">$</span>mean <span class="sc">+</span> </span>
<span id="cb25-94"><a href="#cb25-94" aria-hidden="true" tabindex="-1"></a>  carrot_seasonal_forecast<span class="sc">$</span>mean <span class="sc">+</span> </span>
<span id="cb25-95"><a href="#cb25-95" aria-hidden="true" tabindex="-1"></a>  carrot_residuals_forecast<span class="sc">$</span>mean</span>
<span id="cb25-96"><a href="#cb25-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-97"><a href="#cb25-97" aria-hidden="true" tabindex="-1"></a><span class="fu">View</span>(carrot_forecast)</span>
<span id="cb25-98"><a href="#cb25-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-99"><a href="#cb25-99" aria-hidden="true" tabindex="-1"></a>carrot_forecast_upper <span class="ot">&lt;-</span> carrot_trend_forecast<span class="sc">$</span>upper <span class="sc">+</span> </span>
<span id="cb25-100"><a href="#cb25-100" aria-hidden="true" tabindex="-1"></a>  carrot_seasonal_forecast<span class="sc">$</span>upper <span class="sc">+</span> </span>
<span id="cb25-101"><a href="#cb25-101" aria-hidden="true" tabindex="-1"></a>  carrot_residuals_forecast<span class="sc">$</span>upper</span>
<span id="cb25-102"><a href="#cb25-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-103"><a href="#cb25-103" aria-hidden="true" tabindex="-1"></a><span class="fu">View</span>(carrot_forecast_upper)</span>
<span id="cb25-104"><a href="#cb25-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-105"><a href="#cb25-105" aria-hidden="true" tabindex="-1"></a>carrot_forecast_lower <span class="ot">&lt;-</span> carrot_trend_forecast<span class="sc">$</span>lower <span class="sc">+</span> </span>
<span id="cb25-106"><a href="#cb25-106" aria-hidden="true" tabindex="-1"></a>  carrot_seasonal_forecast<span class="sc">$</span>lower <span class="sc">+</span> </span>
<span id="cb25-107"><a href="#cb25-107" aria-hidden="true" tabindex="-1"></a>  carrot_residuals_forecast<span class="sc">$</span>lower</span>
<span id="cb25-108"><a href="#cb25-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-109"><a href="#cb25-109" aria-hidden="true" tabindex="-1"></a><span class="fu">View</span>(carrot_forecast_lower)</span>
<span id="cb25-110"><a href="#cb25-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-111"><a href="#cb25-111" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert forecasted values into a tibble with corresponding dates</span></span>
<span id="cb25-112"><a href="#cb25-112" aria-hidden="true" tabindex="-1"></a>carrot_forecast_df <span class="ot">&lt;-</span> <span class="fu">tibble</span>( <span class="co"># Create a tibble (a modern dataframe in R)</span></span>
<span id="cb25-113"><a href="#cb25-113" aria-hidden="true" tabindex="-1"></a>  <span class="at">price =</span> carrot_forecast, <span class="co"># Stores the forecasted price values</span></span>
<span id="cb25-114"><a href="#cb25-114" aria-hidden="true" tabindex="-1"></a>  <span class="at">upper =</span> carrot_forecast_upper[,<span class="dv">1</span>], <span class="co"># Extracts the upper confidence interval for the forecast</span></span>
<span id="cb25-115"><a href="#cb25-115" aria-hidden="true" tabindex="-1"></a>  <span class="at">lower =</span> carrot_forecast_lower[,<span class="dv">1</span>] <span class="co"># Extracts the lower confidence interval for the forecast</span></span>
<span id="cb25-116"><a href="#cb25-116" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb25-117"><a href="#cb25-117" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">measure_date =</span> <span class="fu">seq</span>(<span class="fu">as_date</span>(<span class="st">"2023-08-01"</span>), <span class="at">by =</span> <span class="st">"months"</span>, <span class="at">length.out =</span> <span class="fu">nrow</span>(.))) <span class="co"># Add a variable called measure_date</span></span>
<span id="cb25-118"><a href="#cb25-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-119"><a href="#cb25-119" aria-hidden="true" tabindex="-1"></a><span class="co"># Keep only forecasted data that occurs after the last observed date</span></span>
<span id="cb25-120"><a href="#cb25-120" aria-hidden="true" tabindex="-1"></a>carrot_forecast_df <span class="ot">&lt;-</span> carrot_forecast_df <span class="sc">%&gt;%</span></span>
<span id="cb25-121"><a href="#cb25-121" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(measure_date <span class="sc">&gt;</span> <span class="fu">max</span>(carrot_decomp_out<span class="sc">$</span>measure_date)) <span class="sc">%&gt;%</span></span>
<span id="cb25-122"><a href="#cb25-122" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">forecast =</span> <span class="cn">TRUE</span>) <span class="co"># Mark these as forecasted values</span></span>
<span id="cb25-123"><a href="#cb25-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-124"><a href="#cb25-124" aria-hidden="true" tabindex="-1"></a><span class="co"># Append forecasted data to the original dataset</span></span>
<span id="cb25-125"><a href="#cb25-125" aria-hidden="true" tabindex="-1"></a>final_out <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(carrot_decomp_out,carrot_forecast_df)</span>
<span id="cb25-126"><a href="#cb25-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-127"><a href="#cb25-127" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the final dataset as a CSV file</span></span>
<span id="cb25-128"><a href="#cb25-128" aria-hidden="true" tabindex="-1"></a><span class="fu">write_csv</span>(final_out,<span class="st">"carrot_forecast.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
</section>
</section>
<section id="tableau" class="level1">
<h1>Tableau</h1>
<p>Now we will use Tableau to visualize the <strong>forecasted time series</strong> and its <strong>decomposed components</strong> from <strong>R</strong> using <code>carrot_forecast.csv</code>.</p>
<section id="step-1-connect-your-data-in-tableau" class="level2">
<h2 class="anchored" data-anchor-id="step-1-connect-your-data-in-tableau">Step 1: Connect Your Data in Tableau</h2>
<ol type="1">
<li>Open <strong>Tableau</strong> and connect to the <strong>CSV file</strong> you exported from R (<code>carrot_forecast.csv</code>).
<ul>
<li>This file contains:
<ul>
<li><strong>Observed carrot prices</strong> (<code>price</code>)</li>
<li><strong>Forecasted values</strong> (<code>forecast</code>)</li>
<li><strong>Three decomposition components</strong> (<code>trend</code>, <code>seasonality</code>, <code>random</code>)</li>
</ul></li>
</ul></li>
<li>Make sure the fields are correctly formatted in Tableau. If necessary, change the data types so each variable is formatted correctly:
<ul>
<li><code>measure_date</code> = <strong>Date</strong></li>
<li><code>price</code>, <code>seasonal</code>, <code>trend</code>, <code>random</code>, <code>upper</code>, <code>lower</code> = <strong>Number (decimal)</strong></li>
<li><code>forecast</code> = <strong>Boolean</strong></li>
</ul></li>
</ol>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>If you are working with multiple time series data, <strong>filter</strong> the <code>measure_date</code> field so that all worksheets begin at the relevant <strong>start date</strong> for your analysis.</p>
</div>
</div>
</section>
<section id="step-2-visualizing-time-series-decomposition" class="level2">
<h2 class="anchored" data-anchor-id="step-2-visualizing-time-series-decomposition">Step 2: Visualizing Time Series Decomposition</h2>
<p>In <strong>Sheet 1</strong>:</p>
<ol type="1">
<li>Plot the raw price data as a line chart.
<ul>
<li>Add <code>price</code> to the row shelf. Display as AVG(Price).</li>
<li>Add <code>measure_date</code> to the column shelf. Display <code>measure_date</code> as Measure &gt; MONTH().</li>
</ul></li>
<li>Make sure forecasted values (<code>forecast</code> = TRUE) are <strong>filtered out</strong> when generating the line graph.
<ul>
<li>Drag <code>forecast</code> to the Filters card. Check the box next to True. Click OK.</li>
</ul></li>
<li>Add the trend, seasonal, and random components as new panes below the price line.
<ul>
<li>Add <code>trend</code> to the row shelf. Display as AVG(Trend).</li>
<li>Add <code>seasonal</code> to the row shelf. Display as AVG(Seasonal).</li>
<li>Add <code>random</code> to the row shelf. Display as AVG(Random).</li>
</ul></li>
<li>Experiment with Tableau’s built-in smoothing:
<ul>
<li>Convert the raw price data to a <strong>moving average</strong> using <strong>Quick Table Calculation</strong>.<br>
</li>
<li>Compare Tableau’s moving average to the one calculated in R.</li>
</ul></li>
<li>Add a caption answering the following questions:
<ul>
<li>What are the <strong>overall trends</strong> in the data?<br>
</li>
<li>Which seasons have <strong>higher or lower prices</strong>?<br>
</li>
<li>How much variation remains <strong>unexplained</strong> after removing trend and seasonality?</li>
</ul></li>
</ol>
</section>
<section id="step-3-forecasting-in-tableau" class="level2">
<h2 class="anchored" data-anchor-id="step-3-forecasting-in-tableau">Step 3: Forecasting in Tableau</h2>
<p>In <strong>Sheet 2</strong>:</p>
<ol type="1">
<li>Create a new calculated field called <code>observed_price</code>.
<ul>
<li><code>IF [Forecast]=FALSE THEN [Price] ELSE NULL END</code></li>
</ul></li>
<li>Plot the observed prices as a line chart.
<ul>
<li>Add <code>measure_date</code> to the column shelf. Display <code>measure_date</code> as Measure &gt; MONTH().</li>
<li>Add <code>observed_price</code> to the row shelf. Display as AVG(observed_price).</li>
<li>Drag <code>forecast</code> to the Filters card. Check the box next to True. Click OK.</li>
</ul></li>
<li>Create a forecast in Tableau.
<ul>
<li>Switch to the Analytics tab from the Data tab. In the Analytics tab, there is a Forecast option under the Model section.</li>
<li>To add a forecast to this plot, hold the Forecast option and drag it on to the scatter plot (or visualization area). You will see that it gives us one option that we can add to our graph.</li>
<li>To change the forecast, right click on the confidence interval around the forecasted values. Select Forecast &gt; Forecast Options…</li>
<li><strong>What do you notice?</strong></li>
</ul></li>
</ol>
</section>
<section id="step-4-compare-tableaus-forecast-with-rs-forecast" class="level2">
<h2 class="anchored" data-anchor-id="step-4-compare-tableaus-forecast-with-rs-forecast">Step 4: Compare Tableau’s forecast with R’s forecast</h2>
<p>In <strong>Sheet 3</strong>:</p>
<ol type="1">
<li><p>Plot the raw price data as a line chart.</p>
<ul>
<li>Add <code>price</code> to the row shelf. Display as AVG(Price).</li>
<li>Add <code>measure_date</code> to the column shelf. Display <code>measure_date</code> as Measure &gt; MONTH().</li>
</ul></li>
<li><p>Drag <code>forecast</code> to the Color Marks Card.</p></li>
<li><p>Plot the upper and lower bounds of the confidence interval of the forecasted values.</p>
<ul>
<li>Add <code>upper</code> to the row shelf. Display as AVG(upper).</li>
<li>Right click <code>upper</code> and select Dual Axis.</li>
<li>Hover over the secondary axis that corresponds with Avg. Upper. Right click it. Select Synchronize Axis.</li>
<li>Drag <code>lower</code> to the secondary axis. You will need to reset the axis.</li>
<li>Hover over the axis that corresponds with Avg. Upper. Right click it. Select Synchronize Axis.</li>
<li>Now you will see all lines: observed prices, forecasted prices, the upper bound, the lower bound.</li>
</ul></li>
<li><p>Create a <strong>new dashboard</strong> that combines both forecasts:</p>
<ul>
<li><strong>The forecast generated in R</strong> (<code>forecast</code> = TRUE)</li>
<li><strong>The forecast generated in Tableau</strong></li>
</ul></li>
<li><p>Add a text box to explain forecast differences:</p>
<ul>
<li>Why do the R and Tableau forecasts differ?<br>
</li>
<li>Which model appears more accurate?<br>
</li>
<li>How does seasonality impact the predictions?</li>
</ul></li>
<li><p><strong>Hide unnecessary worksheets</strong>:</p>
<ul>
<li>Right-click the worksheet tab → Select <code>Hide</code>.</li>
</ul></li>
</ol>
</section>
<section id="step-5-identifying-seasonal-trends" class="level2">
<h2 class="anchored" data-anchor-id="step-5-identifying-seasonal-trends">Step 5: Identifying Seasonal Trends</h2>
<ol type="1">
<li>Create a dashboard to analyze seasonal trends.
<ul>
<li>Compare price patterns by <strong>month</strong> (as we did in Step 2) vs.&nbsp;<strong>quarter</strong>. Go through the same process as we did for Step 2, but display <code>measure_date</code> as Measure &gt; QUARTER().</li>
</ul></li>
<li>Add a text box describing important takeaways:
<ul>
<li>Are trends more apparent when comparing months vs.&nbsp;quarters?<br>
</li>
<li>Are there <strong>notable differences</strong> in annual trends within a given month or quarter?</li>
</ul></li>
</ol>
</section>
<section id="final-step-publish-to-tableau-public" class="level2">
<h2 class="anchored" data-anchor-id="final-step-publish-to-tableau-public">Final Step: Publish to Tableau Public</h2>
<ol type="1">
<li>Format your workbook following the guidelines for effective visualizations:
<ul>
<li>Add <strong>color</strong>, <strong>titles</strong>, and <strong>labels</strong> to improve readability.<br>
</li>
<li>Make sure that all charts effectively communicate your insights.</li>
</ul></li>
<li>Publish your workbook to Tableau Public. Your workbook should include:
<ul>
<li><strong>One worksheet</strong> (Step 2 - Time Series Decomposition from R)<br>
</li>
<li><strong>Two dashboards</strong> (Step 3 - Forecasting &amp; Step 4 - Seasonal Trends)</li>
</ul></li>
</ol>
<!--
# Tableau

We will use Tableau to visualize your R forecasts.

## Visualizing R Forecasts in Tableau

First, let's visualize our decomposition:

1. Connect to the carrot price forecast data you exported in R. To keep everything in the same workbook, create a connection between these data and your original carrot price data (using the Date) variable

2. Plot your raw data

3. Add the trend line you calculated in R to the pane below this

4. Show the seasonality you calculated in R in a pane below this

5. Finally, show the residuals in the pane below this

6. You can also play with combining these figures as you see appropriate (e.g., I like to look at the trend line in the same pane as the actual data)

7. As an aside - let's change the raw price data to a “moving average” using Tableau's quick table calculation. Why is this moving average different from the one you calculated in R?
-->
<!-- ## Tableau’s Forecasting -->
<!-- Let’s load your carrot price data you exported from R into Tableau and check out Tableau’s forecasting features. -->
<!-- 1. Once you are connected to the carrot price data, let’s create a filter for our entire workbook so that we only use more recent data (after our structural break) in the forecasting exercise.   -->
<!--     - On the Data Source page, click `filter` in the top right. -->
<!--    - Filter Date to begin August 1, 2007 -->
<!-- 2. Open a new worksheet and plot the monthly carrot price data over time.   -->
<!-- 3. Two ways to add a forecast - Right click or go to the `Analytics` tab on the left pane.   -->
<!-- Now you have added a forecast line that Tableau has decided is a good fit of your data. (Along with 95% confidence bands) Let’s explore this forecast. -->
<!-- 1. Right click on your visualization and select `Forecast` -> `Describe Forecast...`   -->
<!--    - Did Tableau use the entire time period when constructing the forecast? -->
<!--        - What time period is Tableau forecasting for? -->
<!--    - Does Tableau think this forecast is accurate? -->
<!--    - If you want to learn more about this description, click the link at the bottom of the window. -->
<!-- 2. Click on `Models` at the top of the window. -->
<!--    - This gives you information about the forecasting model Tableau has applied, including how it is weighting values (past vs. more recent), and measures of “fit”. -->
<!--    - If you want to learn more about the Tableau forecasting models, click the link at the bottom of the window. -->
<!-- Now, let’s adjust Tableau’s recommended forecast as we see fit. -->
<!-- 1. Right click on your visualization and select `Forecast` -> `Forecast Options...` -->
<!-- 2. Adjust the forecast length by selecting `Exactly` or `Until` -->
<!-- 3. Adjust the ignored periods (this is useful if your data only include part of a year, or if you have reason to believe the more recent data are not as useful) - what happens to the forecast as you adjust this? -->
<!-- 4. Change the forecast model from `Automatic` to `Custom` and adjust the model parameters. Which do you like best? -->
<!-- 5. Once you have created a forecast you are satisfied with, exit the popup window. Right click your worksheet tab and select `Duplicate as Crosstab`. Now you can easily see the values of your forecast. -->
<!-- Note that the initial forecast you saw was the one that Tableau determined to yield the highest quality prediction given your data, but it really was not a great prediction. R has much better forecasting capabilities, including more flexibility in the models you can apply, and more transparent algorithms. Best practice is to forecast in R, then visualize your forecast and its decomposition in Tableau. -->
<!--



---
title: "Week 6 Lab: Regression and Structural Breaks"
format: 
  html:
    theme: zephyr
    toc: true
---





![](includes/generic_forecasting.webp)

::: {style="font-size: 1.5em"}
This Lab Contributes to Course Objectives: 1, 2, 3, 4, 7, 8
:::

## Learning Objectives R

- Understand time series decomposition in R

- Understand the steps of forecasting using a decomposition in R


## Learning Objectives Tableau

- Apply Tableau's default forecasting

- Customize Tableau's forecasting

- Visualize decompositions and forecasts created in R

- Create advanced visualizations to demonstrate seasonality and overall trends in time series data

## Unit 1 Project Overview

# R: Time Series Decomposition

### Step 1: Load your data

First, you need to load your time series data into R and set up your script (description, working directory, load packages).



::: {.cell}

```{.r .cell-code}
carrot <- tq_get(c("WPU01130212"),get = "economic.data",from="2007-08-01")
```
:::



### Step 2: Convert your data into a time series object

Next, you need to convert your data into a time series object that R can work with. To do this, you can use the `ts()` function in R. The `ts()` function takes two arguments: `data` and `frequency.` `data` is a vector or matrix of your time series data, and `frequency` is the number of observations per unit time (e.g., the number of observations per year, per month, etc.). In the case of the carrots dataset, the frequency is 12 (since there are 12 observations per year).

To convert the `carrot` dataset into a time series object, run the following command:



::: {.cell}

```{.r .cell-code}
carrot_ts <- ts(carrot$price,frequency = 12,start=c(2007,8))
```
:::



This will create a new time series object called `ts_data.`

### Step 3: Decompose your time series data

Now that you have your time series data in a format that R can work with, you can use the `decompose()` function to decompose it into its underlying components. The `decompose()` function takes one argument: `x`, which is the time series object you want to decompose.

To decompose the `carrot_ts` time series object, run the following command:



::: {.cell}

```{.r .cell-code}
carrot_decomp <- decompose(carrot_ts)
```
:::




This will create a new object called `carrot_decomp` that contains the decomposed components of the `carrot_ts` time series object.

### Step 4: Examine the results of the decomposition

Finally, you can examine the results of the time series decomposition by plotting the decomposed components. The `carrot_decomp` object contains four components: `trend`, `seasonal`, `random`, and `figure`. You can access each of these components using the `$` operator.

To plot the decomposed components, run the following command:



::: {.cell}

```{.r .cell-code}
plot(carrot_decomp$trend)
plot(carrot_decomp$seasonal)
plot(carrot_decomp$random)
```
:::



This will create three separate plots that show the trend, seasonal, and random components of the time series data. You can use these plots to better understand the underlying patterns in your data.

Let's store this all in a dataframe. For this operation, you will need to load the packages: `readr`and `dplyr`. 



::: {.cell}

```{.r .cell-code}
carrot_decomp_out <- carrot_decomp[1:4] %>%
  as_tibble() %>%
  rename(price=x) %>%
  mutate(measure_date=carrot$date)
```
:::




## R: Forecasting

Make sure to add the library `forecast` where you load packages.

### Step 1: Extract the trend, seasonal, and residual components

Next, we'll extract the estimated trend, seasonal, and residual components from the decompose object using the `$` operator:



::: {.cell}

```{.r .cell-code}
# Extract the trend, seasonal, and residual components
carrot_trend <- carrot_decomp$trend
carrot_seasonal <- carrot_decomp$seasonal
carrot_residuals <- carrot_decomp$random
```
:::



### Step 2: Forecast the trend, seasonal, and residual components

To forecast each component, we'll use the `forecast()` function from the `forecast` package in R. For the trend and seasonal components, we can simply use the `forecast()` function on the corresponding time series objects:



::: {.cell}

```{.r .cell-code}
# Forecast the trend component for the next 12 months
carrot_trend_forecast <- forecast(carrot_trend, h=60)

plot(carrot_trend_forecast)

# Forecast the seasonal component for the next 12 months
carrot_seasonal_forecast <- forecast(carrot_seasonal, h=60)

plot(carrot_seasonal_forecast)
```
:::



For the residual component, we'll need to create a model to forecast the residuals. There are many possible approaches to modeling the residuals, but a simple one is to use a moving average model (MA model). Here's an example of how to create a simple MA(1) model for the residuals:



::: {.cell}

```{.r .cell-code}
# Create a time series object for the residuals
carrot_residuals_ts <- ts(carrot_residuals, frequency=12, start=c(2007, 8))

# Fit an MA(1) model to the residuals
carrot_residuals_model <- arima(carrot_residuals_ts, order=c(0,0,1))

# Forecast the residuals for the next 12 months
carrot_residuals_forecast <- forecast(carrot_residuals_model, h=60)$mean
```
:::



### Step 3: Combine the forecasted components to obtain the final forecast

Finally, we can combine the forecasted trend, seasonal, and residual components to obtain the final forecast for the time series:



::: {.cell}

```{.r .cell-code}
# Combine the forecasted components to obtain the final forecast
carrot_forecast <- carrot_trend_forecast$mean + carrot_seasonal_forecast$mean + carrot_residuals_forecast
```
:::



This creates the forecast, which is just the future values.  We want to append this to the existing time series.  First, we will convert this vector into a data frame (a special one called a tibble).



::: {.cell}

```{.r .cell-code}
carrot_forecast_df <- tibble(price=carrot_forecast) %>%
  mutate(measure_date=seq(as_date("2022-08-01"), by="months", length.out=nrow(.))) 
```
:::



Now, we need to append it to our current data.  However, there is some overlap with the actual observed data because some data was lost in the moving average calculation in the decomposition. For the overlapping data, we could either keep both, just the forecast, or just the observed.  Let's just keep the observed and append the remainder of the forecast to `carrot_decomp_out`.



::: {.cell}

```{.r .cell-code}
carrot_forecast_df <- carrot_forecast_df %>%
  filter(measure_date > max(carrot_decomp_out$measure_date)) %>%
  mutate(forecast=T)

final_out <- bind_rows(carrot_decomp_out,carrot_forecast_df)
```
:::



Now you can export this data for Tableau



::: {.cell}

```{.r .cell-code}
write_csv(final_out,"carrot_forecast.csv")
```
:::




# Tableau

Tableau has its own forecasting features, but these are much less informative and flexible than what you ca do in R. Today we will show you how to use and customize Tableau’s forecasting features, how to create visualizations using your (improved) R forecasts, and we will show you how to create visualizations that show trends and cyclicality in your data — key components of your forecast!

## 1. Tableau’s Forecasting

Let’s load our carrot price data into Tableau and check out Tableau’s forecasting features.

1. Once you are connected to the carrot price data, let’s create a filter for our entire workbook so that we only use more recent data (after our structural break) in the forecasting exercise.  

    - On the Data Source page, click `filter` in the top right.

    - Filter Date to begin August 1, 2007

2. Open a new worksheet and plot the monthly carrot price data over time.  

3. Two ways to add a forecast - Right click or go to the `Analytics` tab on the left pane.  

Now you have added a forecast line that Tableau has decided is a good fit of your data. (Along with 95% confidence bands) Let’s explore this forecast.

1. Right click on your visualization and select `Forecast` -> `Describe Forecast...`  

    - Did Tableau use the entire time period when constructing the forecast?

        - What time period is Tableau forecasting for?

    - Does Tableau think this forecast is accurate?

    - If you want to learn more about this description, click the link at the bottom of the window.

2. Click on `Models` at the top of the window.

    - This gives you information about the forecasting model Tableau has applied, including how it is weighting values (past vs. more recent), and measures of “fit”.

    - If you want to learn more about the Tableau forecasting models, click the link at the bottom of the window.

Now, let’s adjust Tableau’s recommended forecast as we see fit.

1. Right click on your visualization and select `Forecast` -> `Forecast Options...`

2. Adjust the forecast length by selecting `Exactly` or `Until`

3. Adjust the ignored periods (this is useful if your data only include part of a year, or if you have reason to believe the more recent data are not as useful) - what happens to the forecast as you adjust this?

4. Change the forecast model from `Automatic` to `Custom` and adjust the model parameters. Which do you like best?

5. Once you have created a forecast you are satisfied with, exit the popup window. Right click your worksheet tab and select `Duplicate as Crosstab`. Now you can easily see the values of your forecast.


Note that the initial forecast you saw was the one that Tableau determined to yield the highest quality prediction given your data, but it really was not a great prediction. R has much better forecasting capabilities, including more flexibility in the models you can apply, and more transparent algorithms. Best practice is to forecast in R, then visualize your forecast and its decomposition in Tableau.

## 2. Visualizing R Forecasts in Tableau

First, let’s visualize our decomposition:

1. Connect to the carrot price forecast data you exported in R. To keep everything in the same workbook, create a connection between these data and your original carrot price data (using the Date) variable

2. Plot your raw data

3. Add the trend line you calculated in R to the pane below this

4. Show the seasonality you calculated in R in a pane below this

5. Finally, show the residuals in the pane below this

6. You can also play with combining these figures as you see appropriate (e.g., I like to look at the trend line in the same pane as the actual data)

7. As an aside - let’s change the raw price data to a “moving average” using Tableau’s quick table calculation. Why is this moving average different from the one you calculated in R?


Next, let’s visualize our forecast:

1. Open a new worksheet and plot your carrot price data.

2. Add your forecasted data from R. Change the color of the forecasted data to clarify which is forecasted and which is observed.

And voila! You have both created a good forecast and visualized its components along with the forecast.

## 3. Additional Visualizations for Visualizing Seasonality

I will now quickly walk you through some ideas for showing and identifying seasonality in your data, as well as separating seasonality from overall trends.

1. Line graph over month

    - Gives you some idea of average trends month to month

2. Lines for each year over month

    - Gives you some idea of month to month trends across years

3. Heat map

    - Gives you some idea of months with larger and smaller prices across years

    - Gives you some idea of months with larger changes in prices across years

4. Cycle map

    - This is the best way of visualizing (within year) seasonality and larger trends (across years)
    -->
<!-- Next, let’s visualize our forecast: -->
<!-- 1. Open a new worksheet and plot your carrot price data. -->
<!-- 2. Add your forecasted data from R. Change the color of the forecasted data to clarify which is forecasted and which is observed. -->
<!-- And voila! You have both created a good forecast and visualized its components along with the forecast. -->
<!-- ## 2. Additional Visualizations for Understanding Seasonality -->
<!-- I will now quickly walk you through some ideas for showing and identifying seasonality in your data, as well as separating seasonality from overall trends. -->
<!-- 1. Line graph over month -->
<!--    - Gives you some idea of average trends month to month -->
<!-- 2. Lines for each year over month -->
<!--    - Gives you some idea of month to month trends across years -->
<!-- 3. Heat map -->
<!--    - Gives you some idea of months with larger and smaller prices across years -->
<!--    - Gives you some idea of months with larger changes in prices across years -->
<!-- 4. Cycle map -->
<!--    - This is the best way of visualizing (within year) seasonality and larger trends (across years) -->
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>