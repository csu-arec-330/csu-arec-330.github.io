---
title: "Week 14: <br>Understanding Panel Data Analysis <br>"
format: 
  revealjs:
    theme: [night, ../../custom.scss]
    slide-number: c/t
    width: 1400
    # logo: path.png
    # center: TRUE
execute:
  echo: true
---

## Agenda 

Linear Regression.

Knowledge check.

Differences-in-differences regressions: Intuition.

Differences-in-differences regressions: Assumptions.

Fixed effects regressions: Intuition.

<!-- example of big text fit to slide width -->

<!-- ::: {.r-fit-text} -->
<!-- Big Text -->
<!-- ::: -->

<!-- :::: {.columns style="text-align: center"} -->
<!-- ::: {.column width="40%"} -->
<!-- ::: -->
<!-- ::: {.column width="60%"} -->
<!-- ::: -->
<!-- :::: -->



<!-- ============================= -->
<!-- (4-22-2024) Lauren moved material in from Week 06 (Lecture 01 Week 02) For next year, plan is to re-do Week 06 lecture to be more about forecasting and decomposition. I left the content in there for Week 05 (commented out) for now. -->
<!-- ============================= -->


# Linear Regression

# 
::: {.r-fit-text }
**The objective:** <br>
We want to understand the <br> 
relationship between two variables
:::
#

::: {.r-fit-text }
**The simple solution:** <br> 
Assume the relationship is linear <br> 
and estimate the "average" trend
:::


## Linear regression: The intuition {.scrollable}

Imagine you have been tracking carrot prices for several years and you want to make a prediction about what carrot prices will look like in the future.

You plotted your data on carrot prices, and you want to know: Does the price of carrots relate to how many months have passed since the financial crisis?

::: {.notes}
The financial crisis was a major event that we can expect had a significant effect on food prices. We want to understand if carrot prices increase (or decrease) as more time passes, as this can indicate changes in the cost of production.

:::



## Linear regression: The intuition {.scrollable}

We can use statistical tools to determine the relationship between "Months since financial crisis" and "Carrot price" to answer questions that cannot always be determined by simply looking at a data plot.

The tool is linear regression, or *regression analysis*.

::: {.notes}

:::



## Equation of a line {.scrollable}

:::: {.columns}

::: {.column width="50%"}

Quick review: The equation of a line plotting the relationship between $y$ and $x$ is,
$$y=mx+b $$

Which variable represents the slope?

Which variable represents the intercept?

:::

::: {.column width="50%"}

```{r}
#| fig-width: 5

library(ggplot2,quietly = T)
data.frame(x=seq.int(0,10,1),
           y=seq(3,23,length.out=11)) |>
  ggplot(aes(x,y)) + 
    geom_line() +
    scale_y_continuous(breaks = seq.int(0,24,2),limits = c(0,24)) +
    scale_x_continuous(breaks = seq.int(0,10,2)) 
```
:::

::::

## Shiny App



## Regression analysis {.scrollable}

**Regression analysis** is a tool that examines the average relationship between two (or more) variables.

It helps us understand:

- How an outcome, or the "dependent" variable, (carrot price) changes when one or more "independent" variables (months since the financial crisis) change.

<!-- - What factors predict a change in an outcome, given a change in an independent variable. -->

We use regression analysis to:

- Forecast future values of the dependent variable (e.g., what carrot prices might be in the future, given past responses to economic events).

- Evaluate the strength of each predictor, i.e., which independent variables are most strongly correlated with changes in carrot prices.

::: {.notes}

How an outcome changes in response to an ind. var change: Since the model is specifying the relationship between independent (RHS vars) and an outcome (y or dependent vars), new observed independent vars + the model can predict new outcomes.

:::

## Regression analysis, applied {.scrollable}

We use linear regression, along with our data, to answer:

1.  Are carrot prices, *on average*, increasing or decreasing?

2.  How much of the observed variation in carrot prices can be explained by a simple time-trend line?

3.  What is the most reasonable prediction of carrot prices 250 months after the financial crisis?

## The Ordinary Least Squares Regression 

Ordinary Least Squares (OLS) is the most common estimation method for linear models.

For a good reason: As long as your model satisfies the certain assumptions, you're getting the BEST possible estimates.

BEST = accurate (unbiased) + most precise (best)

Tableau, Excel, and other programs use OLS to estimate trend lines.

## OLS: Unbiased {.scrollable}

What do we mean by "unbiased"?

- predictions are correct on average

- the average value of errors (the distance between observations and predictions) equals zero

# 
![](includes/estimates_bias.png){width="100%"}

::: {style="font-size: 80%;"}
*Source:* [Statistics by Jim](https://statisticsbyjim.com/regression/gauss-markov-theorem-ols-blue/)

:::

## OLS: Best {.scrollable}

What do we mean by "best"?

- predictions have the smallest possible variance

- larger variance = larger probability that our estimates are further away from the correct/true/observed value

# 
![](includes/estimates_precision.png){width="100%"}

::: {style="font-size: 80%;"}
*Source:* [Statistics by Jim](https://statisticsbyjim.com/regression/gauss-markov-theorem-ols-blue/)

:::


## The OLS regression equation {.scrollable}

The following equation represents the mathematical relationship between an independent variable and a dependent variable. 
![](includes/reg_eq.png){width="80%"}

The $\beta_1$ coefficient:

- Acts as the "weight" that the independent variable has in predicting the dependent variable.

- Tells you how much the dependent variable is expected to increase (or decrease) when the independent variable increases by one unit.

The $\beta_0$ coefficient:

- This is our intercept term.

- It is the value of the dependent variable when all the independent variables are zero.

- It represents the expected value of the outcome you're interested in predicting when all of your predictor variables are zero.

::: {.notes}
Beta 1: If you're looking at the relationship between hours studied (independent variable) and exam score (dependent variable), the coefficient of the hours studied tells you how many points you'd expect the exam score to increase for every additional hour studied. If the coefficient is 2, it means that for each additional hour studied, the exam score is expected to increase by 2 points, holding all else constant.

The coefficient essentially acts as a weight that quantifies the impact of one unit change in the independent variable on the dependent variable.

Beta 0: In the same study examining the relationship between hours studied and test scores, the intercept would indicate the predicted test score for a student who did not study at all (zero hours). If the intercept is 50, it suggests that a student is expected to score 50 on the test without studying, assuming the model holds true and all other factors are constant.
:::

## OLS Estimation {.scrollable}

**Problem:** 

We need to estimate $\beta_0$ and $\beta_1$ using observed values of $Y_i$ and $X_i$

**Solution:** 

$$
\widehat{\beta}_0 = \bar{Y} - \frac{\sum_{i=1}^n\left(Y_i-\bar{Y}\right)\left(X_i-\bar{X}\right)}{\sum_{i=1}^n\left( X_i-\bar{X} \right)^2}\cdot \bar{X}
$$

$$
\widehat{\beta}_1 = \frac{\sum_{i=1}^n\left(Y_i-\bar{Y}\right)\left(X_i-\bar{X}\right)}{\sum_{i=1}^n\left( X_i-\bar{X} \right)^2}
$$



<!-- ============================= -->
<!-- Beginning of slides from 2023 -->
<!-- ============================= -->

## Knowledge Check 1 {.scrollable}

In lab you used data to estimate the following D-i-D regression:
$$ Y_{it} = \beta \cdot \text{treated}_{it} + \gamma_t + \delta_i + \varepsilon_{it}$$
Which parameter gave you the effect of a minimum wage increase on employment?

A.  $\beta$ 

B.  $\gamma_t$ 

C.  $\delta_i$ 

D.  $\varepsilon_{it}$

## Knowledge Check 2 {.scrollable}

In lab you used data to estimate the following D-i-D regression:
$$ Y_{it} = \beta \cdot \text{treated}_{it} + \gamma_t + \delta_i + \varepsilon_{it}$$
Which parameter controlled for factors that may have impacted employment across time?

A.  $\beta$ 

B.  $\gamma_t$ 

C.  $\delta_i$ 

D.  $\varepsilon_{it}$

## Knowledge Check 3 {.scrollable}

In lab you used data to estimate the following D-i-D regression:
$$ Y_{it} = \beta \cdot \text{treated}_{it} + \gamma_t + \delta_i + \varepsilon_{it}$$
Which parameter controlled for factors that may have impacted employment across counties?

A.  $\beta$ 

B.  $\gamma_t$ 

C.  $\delta_i$ 

D.  $\varepsilon_{it}$

## Discussion

In lab you used data to estimate the following D-i-D regression:

$$ Y_{it} = \beta \cdot \text{treated}_{it} + \gamma_t + \delta_i + \varepsilon_{it}$$

Which parameters controlled for factors that may have impacted employment across time and space?

**How do these parameters "control" for these factors?**

**How does including these parameters change your regression results and interpretation?**

## Differences-in-Differences (DiD): Intuition

The simplest version of the DiD estimator comes from a two-period, two-group analysis.

Consider our previous analysis of the employment effects of minimum wage increases, simplified to fit this context:

- In 2019, Colorado's minimum wage was $11.10 per hour. 
  
- In 2020, Colorado's minimum wage increased to $12.00 per hour.

# {background-image="includes/co_emp1.png" background-size="contain"}


## DiD: Intuition Knowledge Check 1

Given this information, what effect did the minimum wage increase have on employment?

A.  It increased employment

B.  It decreased employment

C.  It had no effect on employment

D.  Unsure/Unclear effect

## DiD: Intuition Knowledge Check 2

What type of data did I show you in the previous bar graph?

A.  Panel data

B.  Time series data

C.  Cross-sectional data

D.  Repeated cross-sectional data

## DiD: Intuition

Consider our previous analysis of the employment effects of minimum wage increases, simplified to fit this context:

- In 2019, Colorado's minimum wage was $11.10 per hour. 
  
- In 2020, Colorado's minimum wage increased to $12.00 per hour.

- In 2019 and 2020, Wyoming's minimum wage was constant at $7.25 per hour.

# {background-image="includes/co_emp2.png" background-size="contain"}

## DiD: Intuition Knowledge Check 3

Given this information, what effect did the minimum wage increase have on employment?

A.  It increased employment

B.  It decreased employment

C.  It had no effect on employment

D.  Unsure/Unclear effect

## DiD: Intuition Knowledge Check 4

What type of data did I show you in the previous bar graph?

A.  Panel data

B.  Time series data

C.  Cross-sectional data

D.  Repeated cross-sectional data

## DiD: Intuition

Consider our previous analysis of the employment effects of minimum wage increases, simplified to fit this context:

- In 2019, Colorado's minimum wage was $11.10 per hour. 
  
- In 2020, Colorado's minimum wage increased to $12.00 per hour.

- In 2019 and 2020, Wyoming's minimum wage was constant at $7.25 per hour.

# {background-image="includes/co_emp3.png" background-size="contain"}

## DiD: Intuition Knowledge Check 5

Given this information, what effect did the minimum wage increase have on employment?

A.  It increased employment

B.  It decreased employment

C.  It had no effect on employment

D.  Unsure/Unclear effect

## DiD: Intuition Knowledge Check 6

What type of data did I show you in the previous bar graph?

A.  Panel data

B.  Time series data

C.  Cross-sectional data

D.  Repeated cross-sectional data

## DiD: Intuition

How can we use these numbers to estimate the effect of the minimum wage increase?

![](includes/did1.png)

## DiD: Intuition

How can we use these numbers to estimate the effect of the minimum wage increase?

![](includes/did2.png)

## DiD: Intuition

How can we use these numbers to estimate the effect of the minimum wage increase?

![](includes/did3.png)

## DiD: Intuition

How can we use these numbers to estimate the effect of the minimum wage increase?

![](includes/did4.png)

The minimum wage increase caused employment to decrease by 37,760.

Does this seem right to you?

## DiD: The importance of transforming data

How can we use these numbers to estimate the effect of the minimum wage increase?

![](includes/did5.png)


## DiD: The importance of transforming data

How can we use these numbers to estimate the effect of the minimum wage increase?

![](includes/did5.png)

The minimum wage increase caused employment to decrease by 0.7%

## DiD: Comparison to regression results

Consider the following dataset (named df) based on this information:

![](includes/Rdata.png)

## DiD: Comparison to regression results

Then suppose we run the following regression:

```{r}
#| eval: false
# regression using binary treatment indicators
mlm <- lm(employment ~ treated + treat_group + treat_time, data=df)
```

<style>
span.small {
  font-size: smaller;
}
</style>

::: {.fragment}
<p style = "padding: 0px; margin: 0px;"><span class="small"> Note that this is equivalent to our earlier regression equation:</span></p>
<p style = "padding: 0px; margin: 0px;"><span class="small"> $$ Y_{it} = \beta \cdot \text{treated}_{it} + \gamma_t + \delta_i + \varepsilon_{it}$$</span></p>
:::
::: {.fragment} 
<p style = "padding: 0px; margin: 20px;"><span class="small">where $Y_{it}$ is employment in state $i$ and year $t$, </span></p>

<p style = "padding: 0px; margin: 20px;"><span class="small">$\text{treated}_{it}$ is an indicator variable for observations in the treated state (Colorado) in the treatment year (2020),</span></p>

<p style = "padding: 0px; margin: 20px;"><span class="small">and $\gamma_t$ and $\delta_i$ are indicators for each state and year in the sample.</span></p>

:::


## DiD: Comparison to regression results

::: columns
::: {.column width="50%"}

![](includes/did6.jpg)

::: 

::: {.column width="50%"}

|            |   Results   |
|:-----------|:-----------:|
|(Intercept) | 282455.000  |
|treated     | -37760.000  |
|treat_group | 2740565.000 |
|treat_time  |  -6067.000  |
|   |      |
:::
::::

What do each of the coefficients correspond with?

**Why?**

## DiD: Comparison to regression results

What if we run the regression using logged employment?

```{r}
#| eval: false
# convert to logs
df$lemp <- log(df$employment)

# run a regression using logged employment
mlm <- lm(lemp ~ treated + treat_group + treat_time,
          data=df)
```
::: columns
::: {.column width="50%"}

![](includes/did7.png)

::: 

::: {.column width="50%"}

|            |   Results   |
|:-----------|:------:|
|(Intercept) | 12.551 |
|treated     | 0.007 |
|treat_group | 2.370  |
|treat_time  | -0.022 |
|   |      |
:::
::::

#

::: {.r-fit-text}
What if we have data from... 

more than two time periods?

more than two groups?
:::

# {background-image="includes/co_emp4.png" background-size="contain"}

## Our DiD table becomes less helpful

![](includes/did_ex.png)

## Our dataset gets larger

![](includes/did_ex3.png)

## But our regression is exactly the same!

```{r}
#| eval: false
# convert states and years to factor variables
df$state <- as.factor(df$state)
df$year <- as.factor(df$year)
```

Note that this effectively changes our dataset to this:

![](includes/did_ex2.png)

## But our regression is exactly the same!

```{r}
#| eval: false
# convert states and years to factor variables
df$state <- as.factor(df$state)
df$year <- as.factor(df$year)

# convert to logs
df$lemp <- log(df$employment)

# run a regression using logged employment
mlm <- lm(lemp ~ treated + state + year,
          data=df)

# generate regression table
modelsummary(mlm,statistic = "std.error", output = "markdown")
```


## How can we interpret these results? {.smaller}


|             |  Results   |
|:------------|:---------:|
|(Intercept)  |  14.905   |
|             |  (0.005)  |
|treated      |   0.017   |
|             |  (0.008)  |
|stateWyoming |  -2.363   |
|             |  (0.005)  |
|year2019     |   0.013   |
|             |  (0.005)  |
|year2020     |  -0.013   |
|             |  (0.007)  |
|year2021     |  -0.013   |
|             |  (0.007)  |
|             |  |

# DiD Assumptions for Causality

# {background-image="includes/co_emp4.png" background-size="contain"}

## Assumption 1: Parallel trends

This assumption states that prior to the intervention (treatment or policy), the treatment and control units had similar trends in the outcome unit.

**Why is this important?**

# {background-image="includes/did_ex4.png" background-size="contain"}

## Assumption 1: Parallel trends

This assumption states that prior to the intervention (treatment or policy), the treatment and control units had similar trends in the outcome unit.

**Why is this important?**

Satisfying this assumption indicates that the non-treatment group is a good control for the treatment group.

## Assumption 2: The Intervention

This might seem obvious, but we also need to assume that the intervention we are studying is the **only** thing that changed **for treated units in the post-treatment time period**.

## Opinion Question (Open Ended)

![](includes/co_emp4.png)

**Did anything else change between 2019 and 2020?**

## Opinion Question (Open Ended)

![](includes/co_emp4.png)

**Is this problematic for causally identifying the effect of the minimum wage increase?**

## Fixed Effects (FE) Regressions: Intuition

In lab last week you studied the effect of fuel moisture on the prevalence of wildfires using the following regression:

$$ fires_{it} = \beta \cdot fm_{it} + \gamma_t + \delta_i +\varepsilon_{it} $$

::: {.fragment}
This equation looks identical to our difference in differences equation. 

The only difference is that here we have a continuous "treatment" (fm) rather than binary.
:::

## Fixed Effects (FE) Regressions: Intuition

In lab last week you studied the effect of fuel moisture on the prevalence of wildfires using the following regression:

$$ fires_{it} = \beta \cdot fm_{it} + \gamma_t + \delta_i +\varepsilon_{it} $$

What are the role of the fixed effects $\gamma_t$ and $\delta_i$ in this regression?

**Conceptually, what are these parameters doing?**

<section data-background-iframe="https://public.tableau.com/views/fires_fe_ex/county_ttl_fires_year?:language=en-US&:showVizHome=no&:embed=true"
          data-background-interactive>
</section>

## 

## Fixed Effects (FE) Regressions: Intuition

In lab last week you studied the effect of fuel moisture on the prevalence of wildfires using the following regression:

$$ fires_{it} = \beta \cdot fm_{it} + \gamma_t + \delta_i +\varepsilon_{it} $$

What are the role of the fixed effects $\gamma_t$ and $\delta_i$ in this regression?

**Conceptually, what are these parameters doing?**

We are **demeaning** the outcome and predictor variables so that we are identifying effects based on variation *within* our units. [Still confused by FEs?](https://ds4ps.org/pe4ps-textbook/docs/p-040-fixed-effects.html)