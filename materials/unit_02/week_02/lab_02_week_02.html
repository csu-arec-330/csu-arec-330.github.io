<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.280">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Week 10 Lab: Intro to Analyzing Cross-Sectional Data</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="lab_02_week_02_files/libs/clipboard/clipboard.min.js"></script>
<script src="lab_02_week_02_files/libs/quarto-html/quarto.js"></script>
<script src="lab_02_week_02_files/libs/quarto-html/popper.min.js"></script>
<script src="lab_02_week_02_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="lab_02_week_02_files/libs/quarto-html/anchor.min.js"></script>
<link href="lab_02_week_02_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="lab_02_week_02_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="lab_02_week_02_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="lab_02_week_02_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="lab_02_week_02_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#learning-objectives-r" id="toc-learning-objectives-r" class="nav-link active" data-scroll-target="#learning-objectives-r">Learning Objectives R</a></li>
  <li><a href="#learning-objectives-tableau" id="toc-learning-objectives-tableau" class="nav-link" data-scroll-target="#learning-objectives-tableau">Learning Objectives Tableau</a></li>
  <li><a href="#r" id="toc-r" class="nav-link" data-scroll-target="#r">R</a>
  <ul class="collapse">
  <li><a href="#exploratory-data-analysis" id="toc-exploratory-data-analysis" class="nav-link" data-scroll-target="#exploratory-data-analysis">Exploratory Data Analysis</a></li>
  <li><a href="#clustering-analysis" id="toc-clustering-analysis" class="nav-link" data-scroll-target="#clustering-analysis">Clustering Analysis</a></li>
  <li><a href="#regression" id="toc-regression" class="nav-link" data-scroll-target="#regression">Regression</a></li>
  <li><a href="#classification" id="toc-classification" class="nav-link" data-scroll-target="#classification">Classification</a></li>
  </ul></li>
  <li><a href="#tableau" id="toc-tableau" class="nav-link" data-scroll-target="#tableau">Tableau</a>
  <ul class="collapse">
  <li><a href="#tableaus-geocoding" id="toc-tableaus-geocoding" class="nav-link" data-scroll-target="#tableaus-geocoding">1. Tableau’s Geocoding</a></li>
  <li><a href="#tableaus-spatial-data-capabilities" id="toc-tableaus-spatial-data-capabilities" class="nav-link" data-scroll-target="#tableaus-spatial-data-capabilities">2. Tableau’s Spatial Data Capabilities</a></li>
  <li><a href="#symbol-vs.-filled-maps" id="toc-symbol-vs.-filled-maps" class="nav-link" data-scroll-target="#symbol-vs.-filled-maps">3. Symbol vs.&nbsp;Filled Maps</a></li>
  <li><a href="#creating-a-symbol-map" id="toc-creating-a-symbol-map" class="nav-link" data-scroll-target="#creating-a-symbol-map">4. Creating a Symbol Map</a></li>
  <li><a href="#creating-a-filled-map" id="toc-creating-a-filled-map" class="nav-link" data-scroll-target="#creating-a-filled-map">5. Creating a Filled Map</a></li>
  <li><a href="#customizing-your-maps" id="toc-customizing-your-maps" class="nav-link" data-scroll-target="#customizing-your-maps">6. Customizing your maps</a></li>
  <li><a href="#working-with-individual-level-data" id="toc-working-with-individual-level-data" class="nav-link" data-scroll-target="#working-with-individual-level-data">7. Working with Individual-level data</a></li>
  </ul></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Week 10 Lab: Intro to Analyzing Cross-Sectional Data</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<p><img src="includes/cross-sectional.png" class="img-fluid"></p>
<div style="font-size: 1.5em">
<p>This Lab Contributes to Course Objectives: 1, 3, 4, 5, 7, 8</p>
</div>
<section id="learning-objectives-r" class="level2">
<h2 class="anchored" data-anchor-id="learning-objectives-r">Learning Objectives R</h2>
<ul>
<li><p>Conduct exploratory data analysis</p></li>
<li><p>Conduct cluster analysis</p></li>
</ul>
</section>
<section id="learning-objectives-tableau" class="level2">
<h2 class="anchored" data-anchor-id="learning-objectives-tableau">Learning Objectives Tableau</h2>
<ul>
<li><p>Understand Tableau geocoding capabilities</p></li>
<li><p>Explain the different use cases of symbol and filled maps</p></li>
<li><p>Create symbol and filled maps</p></li>
<li><p>Customize Tableau maps</p></li>
<li><p>Aggregate individual-level data by geographic region</p></li>
</ul>
</section>
<section id="r" class="level1">
<h1>R</h1>
<p>This lab will use the Arizona Grocery Store visitation data to introduce <em>cluster analysis</em>, <em>regression</em>, and <em>classification trees/random forests</em> using R. First, we will explore these data to become familiar with the data and remove outliers.</p>
<section id="exploratory-data-analysis" class="level2">
<h2 class="anchored" data-anchor-id="exploratory-data-analysis">Exploratory Data Analysis</h2>
<p>We will use a dataset of grocery store locations in the United States that contains information about the number of visitors, the distance (meters) from visitors’ home, and the median time (minutes) visitors spend in the store. The dataset is provided at <a href="https://csu-arec-330.github.io/materials/unit_02/inputs/arizona_grocery_foot_traffic.csv" class="uri">https://csu-arec-330.github.io/materials/unit_02/inputs/arizona_grocery_foot_traffic.csv</a>. First, set your directory and load the following packages: <code>tidyverse,ggplot2,skimr,GGally,broom,ranger,rsample,caret</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># This script </span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co"># load packages</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(pacman)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">p_load</span>(tidyverse,ggplot2,skimr,GGally,broom,ranger,rsample,caret)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="co"># read in dataset</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>raw <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"https://csu-arec-330.github.io/materials/unit_02/inputs/arizona_grocery_foot_traffic.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The package <code>skimr</code> provides some handy utilities for easily generating summary statistics. We will use <code>skim()</code> to get a quick overview of the data. What do you notice?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>sumstats <span class="ot">&lt;-</span> skimr<span class="sc">::</span><span class="fu">skim</span>(raw)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>sumstats <span class="co">#print the summary stats</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The package <code>GGally</code> provides helpful EDA visualizations using <code>ggplot2</code>. Use <code>ggpairs</code> to visualize density plots and scatter plots to better understand correlation. What do you notice?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggpairs</span>(raw,<span class="at">columns =</span> <span class="fu">c</span>(<span class="st">"raw_visitor_counts"</span>,<span class="st">"distance_from_home"</span>,<span class="st">"median_dwell"</span>)) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The data are heavily skewed and all of the variables have very few observations of very high values (called fat tails). This suggests that we may want to log the data. Let’s take a peak at what the pairs plot would look like if the data were logged. Note that we can use a utility called <code>across()</code> from dplyr to perform the same operation on multiple columns at once.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>raw <span class="sc">%&gt;%</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(raw_visitor_counts,distance_from_home,median_dwell) <span class="sc">%&gt;%</span> <span class="co">#subset only our variables of interest</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">everything</span>(),log)) <span class="sc">%&gt;%</span> <span class="co">#log transform each of the variables. </span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggpairs</span>() <span class="co">#plot the tranformed variables</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The log transform helped correct the skew but not the fat tails in <code>distance_from_home</code> and <code>median_dwell</code>. The very large values in <code>distance_from_home</code> may be visitors to the area with low visitation rate, and the very long dwell times may be employees. Let’s simply remove these very large values for this analysis.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>raw <span class="sc">%&gt;%</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(distance_from_home<span class="sc">&lt;</span><span class="dv">48000</span>,median_dwell<span class="sc">&lt;</span><span class="dv">90</span>) <span class="sc">%&gt;%</span> <span class="co">#keep only stores with median distance from home &lt;48km and median dwell less than 90 minutes</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(raw_visitor_counts,distance_from_home,median_dwell) <span class="sc">%&gt;%</span> <span class="co">#subset only our variables of interest</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">everything</span>(),log)) <span class="sc">%&gt;%</span> <span class="co">#log transform each of the variables. </span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggpairs</span>() <span class="co">#plot the tranformed variables</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This looks better. Let’s keep only those stores labeled as grocery stores, and apply the filter criteria from above.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># select relevant columns and scrub outliers</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> raw <span class="sc">%&gt;%</span> </span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(top_category<span class="sc">==</span><span class="st">"Grocery Stores"</span>, <span class="co">#focus on those classified as grocery stores</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>                distance_from_home<span class="sc">&lt;</span><span class="dv">48000</span>,median_dwell<span class="sc">&lt;</span><span class="dv">90</span>) <span class="sc">%&gt;%</span> <span class="co">#apply outlier filter</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(placekey,raw_visitor_counts,distance_from_home,median_dwell) <span class="sc">%&gt;%</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">c</span>(<span class="dv">2</span><span class="sc">:</span><span class="dv">4</span>),log)) <span class="sc">%&gt;%</span> <span class="co">#log transform</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">drop_na</span>() <span class="co">#drop any observations with missing values</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="clustering-analysis" class="level2">
<h2 class="anchored" data-anchor-id="clustering-analysis">Clustering Analysis</h2>
<p>Our first step will be to standardize the data so the units of the variables do not affect the clustering. Use the function <code>scale()</code> to transform each variable by first subtracting the mean, then dividing by the standard deviation.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># scale data</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>data_scaled <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(raw_visitor_counts,distance_from_home,median_dwell) <span class="sc">%&gt;%</span> <span class="co">#subsetting only the quantitative data</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now, we can estimate the kmeans clustering algorithm with 3 clusters.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># perform k-means clustering with k=3</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>) <span class="co"># for reproducibility</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>kmeans_fit <span class="ot">&lt;-</span> <span class="fu">kmeans</span>(data_scaled, </span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>                     <span class="at">centers=</span><span class="dv">3</span>,  <span class="co">#the number of clusters</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>                     <span class="at">nstart =</span> <span class="dv">25</span>) <span class="co">#the number of random starts</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Assign the clusters back to the data and merge (join) the data back with other store level attributes.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co">#create a dataframe with the store level attribute data not included in the clustering</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>location_info <span class="ot">&lt;-</span> raw <span class="sc">%&gt;%</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(placekey,location_name,top_category,sub_category,latitude,longitude,city,region)</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="co"># add cluster labels to dataset and join to location info</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>data_clustered <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span> </span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">cluster =</span> kmeans_fit<span class="sc">$</span>cluster) <span class="sc">%&gt;%</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(location_info,<span class="at">by=</span><span class="st">"placekey"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we can investigate attributes of the clusters by visualizing the data.</p>
</section>
<section id="regression" class="level2">
<h2 class="anchored" data-anchor-id="regression">Regression</h2>
<p>Suppose you are interested in a specific relationship between variables. Would we expect the relationship between <code>raw_visitor_counts</code> and <code>distance_from_home</code> to be positive or negative? We can test this hypothesis with a regression controlling for <code>median_dwell</code> time. By “controlling for”, we mean that we want to estimate the correlation between <code>raw_visitor_counts</code> and <code>distance_from_home</code> conditional on the correlation between <code>raw_visitor_counts</code> and <code>median_dwell</code>. We can estimate an ordinary least squares model in R using the function <code>lm()</code> that is built into R.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>m1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(raw_visitor_counts <span class="sc">~</span> distance_from_home <span class="sc">+</span> median_dwell, <span class="co">#specifying the regression formula</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>         <span class="at">data =</span> data_clustered) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The coefficient estimates and many other pieces of information are stored in the object <code>m1</code>. We can view a regression table using the function <code>summary(m1)</code>.</p>
<p>We my want to visualize our regression lines in Tableau, so we can generate fitted values of <code>raw_visitor_counts</code> based on data we create to feed our function. We can easily produce a data frame with all combinations of <code>distance_from_home</code> and <code>median_dwell</code> using the function <code>expand_grid()</code>. Then we use the function <code>augment()</code> to generate fitted values for <code>raw_visitor_counts</code> based on our regression model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>new_data <span class="ot">&lt;-</span> <span class="fu">expand_grid</span>(<span class="at">distance_from_home=</span><span class="fu">seq</span>(<span class="dv">5</span>,<span class="dv">11</span>,.<span class="dv">1</span>),</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>                        <span class="at">median_dwell=</span><span class="fu">seq</span>(<span class="dv">1</span>,<span class="dv">7</span>,.<span class="dv">1</span>))</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>fitted_data <span class="ot">&lt;-</span> <span class="fu">augment</span>(m1,<span class="at">newdata =</span> new_data) <span class="sc">%&gt;%</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">raw_visitor_counts=</span>.fitted)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>Save <code>fitted_data</code> for use in Tableau.</strong></p>
</section>
<section id="classification" class="level2">
<h2 class="anchored" data-anchor-id="classification">Classification</h2>
<p>Our second supervised learning technique is classification using random forests. Our goal is to classify the stores as convenience stores or supermarkets based on our quantitative measures: <code>raw_visitor_counts, distance_from_home, median_dwell</code>. First, we can divide the dataset into training and testing samples. We will use the training set of data to <em>train</em> or estimate model parameters, then use the <em>testing</em> set to check the accuracy of the model classification</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Divide data into training and testing sample</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>data_split <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(data_clustered,<span class="at">prop=</span>.<span class="dv">7</span>)</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>train_data <span class="ot">&lt;-</span> <span class="fu">training</span>(data_split)</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>test_data <span class="ot">&lt;-</span> <span class="fu">testing</span>(data_split)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We use the function <code>ranger()</code> to fit the random forest of 500 trees using <code>train_data</code>. In this case, we specify the possible variables the model can use. The model will determine the best variable to split on at each branch.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Fit the random forest model</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>rf_model <span class="ot">&lt;-</span> <span class="fu">ranger</span>(<span class="fu">factor</span>(sub_category) <span class="sc">~</span> raw_visitor_counts <span class="sc">+</span> distance_from_home <span class="sc">+</span> median_dwell, <span class="co">#specify the model like a regression</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>                   <span class="at">data =</span> train_data,</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>                   <span class="at">num.trees =</span> <span class="dv">500</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>One useful way to measure the classification accuracy is via a confusion matrix. A confusion matrix shows the number of correct and incorrect classifications using the testing data. Remember, the model was not trained on the testing data, so this is our best guess at how the model will perform on new unlabeled data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Predict classification of test data</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>rf_predict <span class="ot">&lt;-</span> <span class="fu">predict</span>(rf_model,<span class="at">data =</span> test_data)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>cm <span class="ot">&lt;-</span> <span class="fu">confusionMatrix</span>(rf_predict<span class="sc">$</span>predictions, <span class="co">#calling our predictions from the previous command</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">factor</span>(test_data<span class="sc">$</span>sub_category)) <span class="co">#comparing our modeled classification against the true data</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="co">#print the output</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>cm</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>How well does our model perform?</p>
<p>We can use the model to predict all of the data and merge it with the</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>all_predict <span class="ot">&lt;-</span> <span class="fu">predict</span>(rf_model,<span class="at">data =</span> data_clustered)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>output_data <span class="ot">&lt;-</span> data_clustered <span class="sc">%&gt;%</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">pred_sub_category =</span> all_predict<span class="sc">$</span>predictions)</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="fu">write_csv</span>(output_data,<span class="st">"analyzed_data.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="tableau" class="level1">
<h1>Tableau</h1>
<p>The defining characteristic of cross-sectional data is that we observe values of variables at a single point in, or cross-section of time. Often, but not always, cross-sectional data have geographic compenents that allows us to use Tableau’s mapping features when creating visualizations. Effective analysis of cross-sectional data begins with estimating and conveying useful summary statistics. Today, we will spend most of our time discussing how to do this with spatial data.</p>
<section id="tableaus-geocoding" class="level3">
<h3 class="anchored" data-anchor-id="tableaus-geocoding">1. Tableau’s Geocoding</h3>
<p>If you want to analyze your data geographically, you can plot your data on a map in Tableau.</p>
<p>When building map views, Tableau supports any latitude and longitude coordinates, as long as they are in decimal degrees. Tableau can also recognize and geocode the following geographic information types:</p>
<ul>
<li><p>Airport Codes</p></li>
<li><p>Cities</p></li>
<li><p>Countries</p></li>
<li><p>Regions</p></li>
<li><p>Territories</p></li>
<li><p>States</p></li>
<li><p>Provinces</p></li>
<li><p>Postcodes</p></li>
<li><p>Core Based Statistical Areas (CBSAs)</p></li>
<li><p>Metropolitan Statistical Areas (MSAs)</p></li>
<li><p>U.S. Area Codes</p></li>
<li><p>Congressional Districts</p></li>
<li><p>Zip Codes</p></li>
</ul>
<p>If you have geographic delineations besides these, you will have to use crosswalks or some other means to convert the delineations to one of these forms, or to generate latitudes and longitudes for specific points (e.g., addresses).</p>
</section>
<section id="tableaus-spatial-data-capabilities" class="level3">
<h3 class="anchored" data-anchor-id="tableaus-spatial-data-capabilities">2. Tableau’s Spatial Data Capabilities</h3>
<p>Tableau can also connect to the following spatial file types:</p>
<ul>
<li><p>Shapefiles</p></li>
<li><p>KML files</p></li>
<li><p>GeoJSON files</p></li>
<li><p>TopoJSON files</p></li>
<li><p>Esri File Geodatabases</p></li>
</ul>
<p>These types of files include detailed geographic information that enables us to plot shapes and single points. For example, we can load smoke plume data into Tableau:</p>
<p><img src="includes/smoke_plume.png" class="img-fluid"></p>
</section>
<section id="symbol-vs.-filled-maps" class="level3">
<h3 class="anchored" data-anchor-id="symbol-vs.-filled-maps">3. Symbol vs.&nbsp;Filled Maps</h3>
<section id="symbol-maps" class="level4">
<h4 class="anchored" data-anchor-id="symbol-maps">Symbol Maps</h4>
<p>A symbol map is effective for showing quantitative data for individual locations. For example, you can use a symbol map to show individual store locations on a map.</p>
<p><img src="includes/Sheet1.png" class="img-fluid"></p>
<p>You might want to highlight which stores have <a href="https://www.safegraph.com/data-examples/ohio-grocery-spend">higher spending</a></p>
<p>To create a symbol map, be sure your data source includes the following types of information:</p>
<ul>
<li><p>Quantitative values</p></li>
<li><p>Latitude and longitude coordinates or geographic locations recognized by Tableau</p></li>
</ul>
<p>Symbol maps work best with data containing large variations of values. Without enough variation, the symbols will appear approximately the same size in the view.</p>
</section>
<section id="filled-maps" class="level4">
<h4 class="anchored" data-anchor-id="filled-maps">Filled Maps</h4>
<p>A filled map is ideal when you want to show ratio data. For example, if you wanted to see relative rental rates across Colorado counties, you could use a filled map to show spatial comparisons.</p>
<p><img src="includes/Sheet3.png" class="img-fluid"></p>
<p>To create a filled map, verify that your data source includes the following types of information:</p>
<ul>
<li><p>Quantitative or qualitative values</p></li>
<li><p>Geographic locations recognized by Tableau or custom polygons (from a spatial data file)</p></li>
</ul>
<p><strong>Knowledge Check 1:</strong> Suppose we have county-level data on average gas prices last year. What type of map would you use to show this information?</p>
<p><strong>Knowledge Check 2:</strong> Suppose we have gas station-level data on gas prices yesterday. What type of map would you use to show this information?</p>
</section>
</section>
<section id="creating-a-symbol-map" class="level3">
<h3 class="anchored" data-anchor-id="creating-a-symbol-map">4. Creating a Symbol Map</h3>
<p>Connect to the dataset <code>arizona_grocery_foot_traffic.csv</code>. This is a very very VERY small slice of cell phone visit data from the company <a href="https://www.safegraph.com">Safegraph</a>. The slice includes all grocery retail stores in Arizona with a sufficiently large number of visitors in September of 2021. Visitors (including you if you happened to be in Arizona at that time…) are tracked via their cell phones. The data includes information on the store (name, location, NAICS code, etc.), the number of visits, visitors (unique cell phones), the median distance travelled to shop there, and the median amount of time spent there.</p>
<p>Let’s create a symbol map using the provided latitudes and longitudes of these stores.</p>
<ol type="1">
<li><p>Drag <code>Longitude</code> to the Columns Shelf and <code>Latitude</code> to the Rows Shelf. (You will likely have to change these fields to <code>Dimensions</code>)</p></li>
<li><p>Drag <code>Top Category</code> (this is the top sales category/type of each store) to the colors card.</p></li>
</ol>
<p>Which type of store appears to be the most prevalent?</p>
<ol start="3" type="1">
<li>Now, let’s drag <code>Raw Visit Counts</code> to the size card.</li>
</ol>
<p>Which type of store appears to have the most visitors?</p>
<ol start="4" type="1">
<li>Now, let’s add each store’s name to the tooltip. Drag <code>Location Name</code> to the Tooltip card.</li>
</ol>
<p><strong>You Do It:</strong> Make a new symbol map using each store’s latitude and longitude, and choosing what information you want to include as colors, size, and in the tooltip. What did you uncover?</p>
<p>Now, let’s see what happens if we select a different geographical field to make our map. Select the fields <code>City</code> and <code>Raw Visit Counts</code> and select the Symbol Map in the Show Me Menu. What is this map showing?</p>
<p>What if we change the aggregation of <code>Raw Visit Counts</code> to average instead of sum?</p>
</section>
<section id="creating-a-filled-map" class="level3">
<h3 class="anchored" data-anchor-id="creating-a-filled-map">5. Creating a Filled Map</h3>
<p>Let’s start this exercise with using the same cell phone data. Select the fields <code>Postal Code</code> and <code>Raw Visit Counts</code> and go to the Show Me Menu. Now you should see that you can use either a symbol or filled map. Let’s select the filled map.</p>
<p>What is this showing you? Are you able to map multiple store attributes using this feature? Do you think the filled map or symbol map are better for these data?</p>
<p>Connect to the dataset <code>rent_income_county.csv</code> and create one filled map that shows the median income in each county and one map that shows the median rent in each county.</p>
<p>Now, create a new calculated field called <code>income to rent ratio</code> that equal income divided by rent for each county. Plot this new field on a map and filter your data so that your map only includes Arizona (hint: Arizona’s FIPS code is 4). Which Arizona county has the highest income to rent ratio?</p>
</section>
<section id="customizing-your-maps" class="level3">
<h3 class="anchored" data-anchor-id="customizing-your-maps">6. Customizing your maps</h3>
<p>Tableau includes a variety of features you can include in your maps if you desire. Right click on your map and select <code>Background Layers...</code></p>
<p>Click through some of the map layer options until you find a combination you like.</p>
<p>Now… let’s add some of Tableau’s more recent and VERY COOL integrated data sources. Select the drop down menu next to Data Layer and choose one. Change the geographic level this information is shown for.</p>
<p>Next let’s combine a symbol and filled map:</p>
<ol type="1">
<li><p>Go back to your Tableau window with the cell phone data analysis.</p></li>
<li><p>Create a new worksheet with a filled map showing total visit counts by postal code.</p></li>
<li><p>Command-click (or Control-click on Windows) the latitude measure on the rows shelf and drag it to the right (this copies the value)</p></li>
<li><p>Navigate to the Marks card for the second pane in your figure. Remove the Postal Code field from this map.</p></li>
<li><p>Select both the <code>Latitude</code> and <code>Longitude</code> fields and drag them to the details card.</p></li>
<li><p>Drag <code>Top Category</code> to the colors card. And drag <code>Distance from Home</code> (this is the median travel distance for customers in meters) to the Size card.</p></li>
<li><p>Right click the second <code>Latitude</code> field on the Rows shelf and select <code>Dual Axis</code>.</p></li>
</ol>
<p>Now you can add whatever custom formatting you desire!</p>
<p>What is this combined map showing?</p>
</section>
<section id="working-with-individual-level-data" class="level3">
<h3 class="anchored" data-anchor-id="working-with-individual-level-data">7. Working with Individual-level data</h3>
<p>Next let’s connect to the dataset <code>acs_sample.csv</code>. These data come from the American Community Survey and include all Arizona households interviewed in 2021. I have included only a few of the many variables you can find in the ACS data. If you are interested in seeing the full variable options, I recommend looking at the <a href="https://www.ipums.org">IPUMS website</a>.</p>
<p>Create a filled map that shows average household income (in colors) by county.</p>
<p>Let’s add a pie chart that shows the percentage of households that report receiving food stamps in each county.</p>
<ol type="1">
<li><p>Drag <code>County Fip</code> over the map and drop it on <code>Add a Marks Layer</code></p></li>
<li><p>Navigate to the new Marks card for this second graph and select Pie Chart.</p></li>
<li><p>Drag the <code>County Fip</code> field to the detail card.</p></li>
<li><p>Drag the <code>Foodstmp</code> (this field is equal to 0 if the household did not receive Food Stamp benefits and is equal to 1 if they did) field to the color card and change it to a dimension.</p></li>
<li><p>Then drag the <code>Foodstmp</code> field to the angle card and change it to a count.</p></li>
<li><p>Now create use a quick table calculation to change this to a percent of total, calculated over the Foodstmp field.</p></li>
</ol>
<p>What is this figure showing?</p>
<p>Which county has the highest average income?</p>
<p>Which county has the highest food stamp usage?</p>
<p>Using individual-level (or in this case, household-level) data, you might also be interested in comparing outcomes across dimensions other than geography. For example, how might we show how income and rent compare for AZ households participating in Food Stamps versus for those who do not?</p>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>