<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.280">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Week 10 Lab: Intro to Analyzing Cross-Sectional Data</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="lab_02_week_02_files/libs/clipboard/clipboard.min.js"></script>
<script src="lab_02_week_02_files/libs/quarto-html/quarto.js"></script>
<script src="lab_02_week_02_files/libs/quarto-html/popper.min.js"></script>
<script src="lab_02_week_02_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="lab_02_week_02_files/libs/quarto-html/anchor.min.js"></script>
<link href="lab_02_week_02_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="lab_02_week_02_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="lab_02_week_02_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="lab_02_week_02_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="lab_02_week_02_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#learning-objectives-r" id="toc-learning-objectives-r" class="nav-link active" data-scroll-target="#learning-objectives-r">Learning Objectives R</a></li>
  <li><a href="#learning-objectives-tableau" id="toc-learning-objectives-tableau" class="nav-link" data-scroll-target="#learning-objectives-tableau">Learning Objectives Tableau</a></li>
  <li><a href="#r" id="toc-r" class="nav-link" data-scroll-target="#r">R</a>
  <ul class="collapse">
  <li><a href="#exploratory-data-analysis" id="toc-exploratory-data-analysis" class="nav-link" data-scroll-target="#exploratory-data-analysis">Exploratory Data Analysis</a></li>
  <li><a href="#clustering-analysis" id="toc-clustering-analysis" class="nav-link" data-scroll-target="#clustering-analysis">Clustering Analysis</a></li>
  <li><a href="#regression" id="toc-regression" class="nav-link" data-scroll-target="#regression">Regression</a></li>
  <li><a href="#classification" id="toc-classification" class="nav-link" data-scroll-target="#classification">Classification</a></li>
  </ul></li>
  <li><a href="#tableau" id="toc-tableau" class="nav-link" data-scroll-target="#tableau">Tableau</a>
  <ul class="collapse">
  <li><a href="#plotting-results-from-a-cluster-analysis" id="toc-plotting-results-from-a-cluster-analysis" class="nav-link" data-scroll-target="#plotting-results-from-a-cluster-analysis">1. Plotting Results from a Cluster Analysis</a></li>
  <li><a href="#plotting-results-from-a-regression-analysis" id="toc-plotting-results-from-a-regression-analysis" class="nav-link" data-scroll-target="#plotting-results-from-a-regression-analysis">2. Plotting Results from a Regression Analysis</a></li>
  <li><a href="#adding-vizzes-to-map-tooltips" id="toc-adding-vizzes-to-map-tooltips" class="nav-link" data-scroll-target="#adding-vizzes-to-map-tooltips">3. Adding Vizzes to Map Tooltips</a></li>
  </ul></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Week 10 Lab: Intro to Analyzing Cross-Sectional Data</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<p><img src="includes/cross-sectional.png" class="img-fluid"></p>
<div style="font-size: 1.5em">
<p>This Lab Contributes to Course Objectives: 1, 3, 4, 5, 7, 8</p>
</div>
<section id="learning-objectives-r" class="level2">
<h2 class="anchored" data-anchor-id="learning-objectives-r">Learning Objectives R</h2>
<ul>
<li><p>Conduct exploratory data analysis</p></li>
<li><p>Conduct cluster analysis</p></li>
</ul>
</section>
<section id="learning-objectives-tableau" class="level2">
<h2 class="anchored" data-anchor-id="learning-objectives-tableau">Learning Objectives Tableau</h2>
<ul>
<li><p>Create a map that shows results from cluster analysis</p></li>
<li><p>Create a scatterplot that shows the fitted line from your regression analysis</p></li>
<li><p>Customize Tableau maps: Add Vizzes to tooltip</p></li>
</ul>
</section>
<section id="r" class="level1">
<h1>R</h1>
<p>This lab will use the Arizona Grocery Store visitation data to introduce <em>cluster analysis</em>, <em>regression</em>, and <em>classification trees/random forests</em> using R. First, we will explore these data to become familiar with the data and remove outliers.</p>
<section id="exploratory-data-analysis" class="level2">
<h2 class="anchored" data-anchor-id="exploratory-data-analysis">Exploratory Data Analysis</h2>
<p>We will use a dataset of grocery store locations in the United States that contains information about the number of visitors, the distance (meters) from visitors’ home, and the median time (minutes) visitors spend in the store. The dataset is provided at <a href="https://csu-arec-330.github.io/materials/unit_02/inputs/arizona_grocery_foot_traffic.csv" class="uri">https://csu-arec-330.github.io/materials/unit_02/inputs/arizona_grocery_foot_traffic.csv</a>. First, set your directory and load the following packages: <code>tidyverse,ggplot2,skimr,GGally,broom,ranger,rsample,caret</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># This script </span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co"># load packages</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(pacman)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">p_load</span>(tidyverse,ggplot2,skimr,GGally,broom,ranger,rsample,caret)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="co"># read in dataset</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>raw <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"https://csu-arec-330.github.io/materials/unit_02/inputs/arizona_grocery_foot_traffic.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The package <code>skimr</code> provides some handy utilities for easily generating summary statistics. We will use <code>skim()</code> to get a quick overview of the data. What do you notice?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>sumstats <span class="ot">&lt;-</span> skimr<span class="sc">::</span><span class="fu">skim</span>(raw)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>sumstats <span class="co">#print the summary stats</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The package <code>GGally</code> provides helpful EDA visualizations using <code>ggplot2</code>. Use <code>ggpairs</code> to visualize density plots and scatter plots to better understand correlation. What do you notice?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggpairs</span>(raw,<span class="at">columns =</span> <span class="fu">c</span>(<span class="st">"raw_visitor_counts"</span>,<span class="st">"distance_from_home"</span>,<span class="st">"median_dwell"</span>)) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The data are heavily skewed and all of the variables have very few observations of very high values (called fat tails). This suggests that we may want to log the data. Let’s take a peak at what the pairs plot would look like if the data were logged. Note that we can use a utility called <code>across()</code> from dplyr to perform the same operation on multiple columns at once.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>raw <span class="sc">%&gt;%</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(raw_visitor_counts,distance_from_home,median_dwell) <span class="sc">%&gt;%</span> <span class="co">#subset only our variables of interest</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">everything</span>(),log)) <span class="sc">%&gt;%</span> <span class="co">#log transform each of the variables. </span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggpairs</span>() <span class="co">#plot the tranformed variables</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The log transform helped correct the skew but not the fat tails in <code>distance_from_home</code> and <code>median_dwell</code>. The very large values in <code>distance_from_home</code> may be visitors to the area with low visitation rate, and the very long dwell times may be employees. Let’s simply remove these very large values for this analysis.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>raw <span class="sc">%&gt;%</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(distance_from_home<span class="sc">&lt;</span><span class="dv">48000</span>,median_dwell<span class="sc">&lt;</span><span class="dv">90</span>) <span class="sc">%&gt;%</span> <span class="co">#keep only stores with median distance from home &lt;48km and median dwell less than 90 minutes</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(raw_visitor_counts,distance_from_home,median_dwell) <span class="sc">%&gt;%</span> <span class="co">#subset only our variables of interest</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">everything</span>(),log)) <span class="sc">%&gt;%</span> <span class="co">#log transform each of the variables. </span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggpairs</span>() <span class="co">#plot the tranformed variables</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This looks better. Let’s keep only those stores labeled as grocery stores, and apply the filter criteria from above.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># select relevant columns and scrub outliers</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> raw <span class="sc">%&gt;%</span> </span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(top_category<span class="sc">==</span><span class="st">"Grocery Stores"</span>, <span class="co">#focus on those classified as grocery stores</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>                distance_from_home<span class="sc">&lt;</span><span class="dv">48000</span>,median_dwell<span class="sc">&lt;</span><span class="dv">90</span>) <span class="sc">%&gt;%</span> <span class="co">#apply outlier filter</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(placekey,raw_visitor_counts,distance_from_home,median_dwell) <span class="sc">%&gt;%</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">c</span>(<span class="dv">2</span><span class="sc">:</span><span class="dv">4</span>),log)) <span class="sc">%&gt;%</span> <span class="co">#log transform</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">drop_na</span>() <span class="co">#drop any observations with missing values</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="clustering-analysis" class="level2">
<h2 class="anchored" data-anchor-id="clustering-analysis">Clustering Analysis</h2>
<p>Our first step will be to standardize the data so the units of the variables do not affect the clustering. Use the function <code>scale()</code> to transform each variable by first subtracting the mean, then dividing by the standard deviation.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># scale data</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>data_scaled <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(raw_visitor_counts,distance_from_home,median_dwell) <span class="sc">%&gt;%</span> <span class="co">#subsetting only the quantitative data</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now, we can estimate the kmeans clustering algorithm with 3 clusters.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># perform k-means clustering with k=3</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>) <span class="co"># for reproducibility</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>kmeans_fit <span class="ot">&lt;-</span> <span class="fu">kmeans</span>(data_scaled, </span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>                     <span class="at">centers=</span><span class="dv">3</span>,  <span class="co">#the number of clusters</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>                     <span class="at">nstart =</span> <span class="dv">25</span>) <span class="co">#the number of random starts</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Assign the clusters back to the data and merge (join) the data back with other store level attributes.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co">#create a dataframe with the store level attribute data not included in the clustering</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>location_info <span class="ot">&lt;-</span> raw <span class="sc">%&gt;%</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(placekey,location_name,top_category,sub_category,latitude,longitude,city,region)</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="co"># add cluster labels to dataset and join to location info</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>data_clustered <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span> </span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">cluster =</span> kmeans_fit<span class="sc">$</span>cluster) <span class="sc">%&gt;%</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(location_info,<span class="at">by=</span><span class="st">"placekey"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we can investigate attributes of the clusters by visualizing the data.</p>
</section>
<section id="regression" class="level2">
<h2 class="anchored" data-anchor-id="regression">Regression</h2>
<p>Suppose you are interested in a specific relationship between variables. Would we expect the relationship between <code>raw_visitor_counts</code> and <code>distance_from_home</code> to be positive or negative? We can test this hypothesis with a regression controlling for <code>median_dwell</code> time. By “controlling for”, we mean that we want to estimate the correlation between <code>raw_visitor_counts</code> and <code>distance_from_home</code> conditional on the correlation between <code>raw_visitor_counts</code> and <code>median_dwell</code>. We can estimate an ordinary least squares model in R using the function <code>lm()</code> that is built into R.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>m1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(raw_visitor_counts <span class="sc">~</span> distance_from_home <span class="sc">+</span> median_dwell, <span class="co">#specifying the regression formula</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>         <span class="at">data =</span> data_clustered) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The coefficient estimates and many other pieces of information are stored in the object <code>m1</code>. We can view a regression table using the function <code>summary(m1)</code>.</p>
<p>We my want to visualize our regression lines in Tableau, so we can generate fitted values of <code>raw_visitor_counts</code> based on data we create to feed our function. We can easily produce a data frame with all combinations of <code>distance_from_home</code> and <code>median_dwell</code> using the function <code>expand_grid()</code>. Then we use the function <code>augment()</code> to generate fitted values for <code>raw_visitor_counts</code> based on our regression model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>new_data <span class="ot">&lt;-</span> <span class="fu">expand_grid</span>(<span class="at">distance_from_home=</span><span class="fu">seq</span>(<span class="dv">5</span>,<span class="dv">11</span>,.<span class="dv">1</span>),</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>                        <span class="at">median_dwell=</span><span class="fu">seq</span>(<span class="dv">1</span>,<span class="dv">7</span>,.<span class="dv">1</span>))</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>fitted_data <span class="ot">&lt;-</span> <span class="fu">augment</span>(m1,<span class="at">newdata =</span> new_data) <span class="sc">%&gt;%</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">raw_visitor_counts=</span>.fitted)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>Save <code>fitted_data</code> for use in Tableau.</strong></p>
</section>
<section id="classification" class="level2">
<h2 class="anchored" data-anchor-id="classification">Classification</h2>
<p>Our second supervised learning technique is classification using random forests. Our goal is to classify the stores as convenience stores or supermarkets based on our quantitative measures: <code>raw_visitor_counts, distance_from_home, median_dwell</code>. First, we can divide the dataset into training and testing samples. We will use the training set of data to <em>train</em> or estimate model parameters, then use the <em>testing</em> set to check the accuracy of the model classification</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Divide data into training and testing sample</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>data_split <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(data_clustered,<span class="at">prop=</span>.<span class="dv">7</span>)</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>train_data <span class="ot">&lt;-</span> <span class="fu">training</span>(data_split)</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>test_data <span class="ot">&lt;-</span> <span class="fu">testing</span>(data_split)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We use the function <code>ranger()</code> to fit the random forest of 500 trees using <code>train_data</code>. In this case, we specify the possible variables the model can use. The model will determine the best variable to split on at each branch.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Fit the random forest model</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>rf_model <span class="ot">&lt;-</span> <span class="fu">ranger</span>(<span class="fu">factor</span>(sub_category) <span class="sc">~</span> raw_visitor_counts <span class="sc">+</span> distance_from_home <span class="sc">+</span> median_dwell, <span class="co">#specify the model like a regression</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>                   <span class="at">data =</span> train_data,</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>                   <span class="at">num.trees =</span> <span class="dv">500</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>One useful way to measure the classification accuracy is via a confusion matrix. A confusion matrix shows the number of correct and incorrect classifications using the testing data. Remember, the model was not trained on the testing data, so this is our best guess at how the model will perform on new unlabeled data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Predict classification of test data</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>rf_predict <span class="ot">&lt;-</span> <span class="fu">predict</span>(rf_model,<span class="at">data =</span> test_data)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>cm <span class="ot">&lt;-</span> <span class="fu">confusionMatrix</span>(rf_predict<span class="sc">$</span>predictions, <span class="co">#calling our predictions from the previous command</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">factor</span>(test_data<span class="sc">$</span>sub_category)) <span class="co">#comparing our modeled classification against the true data</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="co">#print the output</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>cm</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>How well does our model perform?</p>
<p>We can use the model to predict all of the data and merge it with the</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>all_predict <span class="ot">&lt;-</span> <span class="fu">predict</span>(rf_model,<span class="at">data =</span> data_clustered)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>output_data <span class="ot">&lt;-</span> data_clustered <span class="sc">%&gt;%</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">pred_sub_category =</span> all_predict<span class="sc">$</span>predictions)</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="fu">write_csv</span>(output_data,<span class="st">"analyzed_data.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="tableau" class="level1">
<h1>Tableau</h1>
<section id="plotting-results-from-a-cluster-analysis" class="level3">
<h3 class="anchored" data-anchor-id="plotting-results-from-a-cluster-analysis">1. Plotting Results from a Cluster Analysis</h3>
<p>If you want to show results from your cluster analysis in Tableau, a simple way is to associate each cluster with a specific color. Let’s do this now.</p>
<ol type="1">
<li><p>Connect to your dataset with the results from your cluster analysis. I called this <code>analyzed_data.csv</code>.</p></li>
<li><p>Select <code>Latitude</code>, <code>Longitude</code>, and <code>Cluster</code> and select the Symbol Map from <code>Show Me</code>.</p></li>
<li><p>Recall you will need to change the <code>Latitude</code> and <code>Longitude</code> fields to Dimensions for this to display correctly.</p></li>
<li><p>Let’s also change <code>Cluster</code> to be associated with a color (rather than size) by dragging it to the <code>Color</code> card.</p></li>
<li><p>Finally, let’s change <code>Cluster</code> to a Dimension and tell Tableau that it is Discrete.</p></li>
<li><p>Let’s add some more detail to the tooltip. I would like to know the location name, top category, and cluster when I hover over each point on the map.</p></li>
</ol>
</section>
<section id="plotting-results-from-a-regression-analysis" class="level3">
<h3 class="anchored" data-anchor-id="plotting-results-from-a-regression-analysis">2. Plotting Results from a Regression Analysis</h3>
<p>We have already discussed how to use Tableau’s integrated regression analysis, but a major limitation to this is that Tableau can only perform single variable regressions. Let’s look at the difference between the single and multivariate regression results by creating a scatterplot in Tableau:</p>
<ol type="1">
<li><p>To compare the single and multivariate regression results we will need to join our <code>analyzed_data</code> and <code>fitted_reg</code> data sources. Join these two datasets on the <code>Raw Visitor Counts</code> field.</p></li>
<li><p>Open a new sheet and create a scatterplot of <code>Raw Visitor Counts</code> and <code>Distance from Home</code> (note that we want our Y variable – <code>Raw Visitor Counts</code> – on the Y-axis).</p></li>
<li><p>Add a fitted line to your scatterplot.</p></li>
<li><p>To plot our multivariate regression results on this 2D plot, we will need to select a fixed value of the second variable (<code>Median Dwell Time</code>). To demonstrate that we need to do this - try plotting the fitted values of <code>Raw Visitor Counts</code> and <code>Distance from Home</code>. What do you see?</p></li>
<li><p>Create a new calculated field, named <code>Fitted Distance From Home</code> with the following formula: <code>IF [Median Dwell (Fitted Reg.Csv)]==3 THEN [Distance From Home (Fitted Reg.Csv)] ELSE NULL END</code></p></li>
</ol>
<p><strong>What is this formula doing?</strong></p>
<ol start="6" type="1">
<li><p>Drag <code>Fitted Distance From Home</code> to the columns shelf, and <code>Raw Visitor Counts (Fitted Reg.Csv)</code> to the rows shelf. Change both fields to Dimensions.</p></li>
<li><p>Change this new plot to a line (instead of scatter).</p></li>
<li><p>Create X and Y dual axes (by right clicking each axis), then synchronize the axes so that they have the same values. Finally you can hide the seconary axes to reduce the clutter.</p></li>
<li><p>How do the multivariate regression fitted values compare with the single variate ones?</p></li>
<li><p>Now, what happens if we look at the fitted values assuming <code>Median Dwell Time</code> is equal to 4? Edit the calculated field to make this change.</p></li>
</ol>
<p>Note that another option for accomplishing this is to simply use the fitted regression equation (from R) to create a new calculated field. To see this, create a new calculated field called <code>Fitted Visits 2</code> with the following formula: <code>8.14165 -0.27568*[Distance From Home] -0.36894*4</code>.</p>
<p><strong>Where did these numbers come from?</strong></p>
</section>
<section id="adding-vizzes-to-map-tooltips" class="level3">
<h3 class="anchored" data-anchor-id="adding-vizzes-to-map-tooltips">3. Adding Vizzes to Map Tooltips</h3>
<p>The last thing I want to cover today is how to add other visualizations to your map tooltip. To do this, let’s create a simple scatterplot of <code>Raw Visitor Counts</code> and <code>Distance from Home</code> and add a fitted line.</p>
<ol type="1">
<li><p>Go back to your sheet with your map, color coded by cluster.</p></li>
<li><p>Open the Tooltip card and go to <code>Insert</code> -&gt; <code>Sheets</code> and select the sheet with your new scatterplot.</p></li>
<li><p>When you hover over a point on the map, what is this visualization showing?</p></li>
<li><p>What if we instead want to show a scatterplot of these two variables only for grocery stores within that cluster? Go back to the Tooltip card and edit the Sheet info from <code>&lt;Sheet name="Sheet 2" maxwidth="300" maxheight="300" filter="&lt;All Fields&gt;"&gt;</code> to read <code>&lt;Sheet name="Sheet 2" maxwidth="300" maxheight="300" filter="&lt;Cluster&gt;"&gt;</code></p></li>
<li><p>Now what happens when you hover over a point on the map? How did we accomplish this?</p></li>
<li><p>Let’s add a useful title to our scatterplot by typing <code>Relationship between Visits and Distance from home for stores in this cluster</code> in the Tooltip above the scatterplot. Then let’s adjust the width of the scatterplot to <code>500</code>.</p></li>
</ol>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>