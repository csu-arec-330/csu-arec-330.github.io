<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Week 10 Lab: Visualizing and Exploring Cross-Sectional Data in Tableau</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="lab_02_week_02_files/libs/clipboard/clipboard.min.js"></script>
<script src="lab_02_week_02_files/libs/quarto-html/quarto.js"></script>
<script src="lab_02_week_02_files/libs/quarto-html/popper.min.js"></script>
<script src="lab_02_week_02_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="lab_02_week_02_files/libs/quarto-html/anchor.min.js"></script>
<link href="lab_02_week_02_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="lab_02_week_02_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="lab_02_week_02_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="lab_02_week_02_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="lab_02_week_02_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#learning-objectives-r" id="toc-learning-objectives-r" class="nav-link active" data-scroll-target="#learning-objectives-r">Learning Objectives: R</a></li>
  <li><a href="#learning-objectives-tableau" id="toc-learning-objectives-tableau" class="nav-link" data-scroll-target="#learning-objectives-tableau">Learning Objectives: Tableau</a></li>
  <li><a href="#download-lab-handout-here" id="toc-download-lab-handout-here" class="nav-link" data-scroll-target="#download-lab-handout-here">Download Lab Handout Here</a></li>
  <li><a href="#part-1-r" id="toc-part-1-r" class="nav-link" data-scroll-target="#part-1-r">Part 1: R</a>
  <ul class="collapse">
  <li><a href="#step-1-set-working-directory-and-load-packages" id="toc-step-1-set-working-directory-and-load-packages" class="nav-link" data-scroll-target="#step-1-set-working-directory-and-load-packages">Step 1: Set Working Directory and Load Packages</a></li>
  <li><a href="#step-2-read-in-and-inspect-the-data" id="toc-step-2-read-in-and-inspect-the-data" class="nav-link" data-scroll-target="#step-2-read-in-and-inspect-the-data">Step 2: Read in and Inspect the Data</a></li>
  <li><a href="#step-3-join-the-data" id="toc-step-3-join-the-data" class="nav-link" data-scroll-target="#step-3-join-the-data">Step 3: Join the Data</a></li>
  <li><a href="#step-4-clean-the-data" id="toc-step-4-clean-the-data" class="nav-link" data-scroll-target="#step-4-clean-the-data">Step 4: Clean the Data</a></li>
  <li><a href="#step-5-create-store-level-summary" id="toc-step-5-create-store-level-summary" class="nav-link" data-scroll-target="#step-5-create-store-level-summary">Step 5: Create Store-Level Summary</a></li>
  <li><a href="#step-6-generate-summary-statistics" id="toc-step-6-generate-summary-statistics" class="nav-link" data-scroll-target="#step-6-generate-summary-statistics">Step 6: Generate Summary Statistics</a></li>
  <li><a href="#step-7-visualize-relationships" id="toc-step-7-visualize-relationships" class="nav-link" data-scroll-target="#step-7-visualize-relationships">Step 7: Visualize Relationships</a></li>
  <li><a href="#step-8-log-transform-skewed-variables" id="toc-step-8-log-transform-skewed-variables" class="nav-link" data-scroll-target="#step-8-log-transform-skewed-variables">Step 8: Log-Transform Skewed Variables</a></li>
  <li><a href="#step-9-cluster-analysis" id="toc-step-9-cluster-analysis" class="nav-link" data-scroll-target="#step-9-cluster-analysis">Step 9: Cluster Analysis</a></li>
  <li><a href="#step-10-what-do-your-clusters-reveal" id="toc-step-10-what-do-your-clusters-reveal" class="nav-link" data-scroll-target="#step-10-what-do-your-clusters-reveal">Step 10: What Do Your Clusters Reveal?</a></li>
  </ul></li>
  <li><a href="#part-2-tableau" id="toc-part-2-tableau" class="nav-link" data-scroll-target="#part-2-tableau">Part 2: Tableau</a>
  <ul class="collapse">
  <li><a href="#symbol-vs.-filled-maps" id="toc-symbol-vs.-filled-maps" class="nav-link" data-scroll-target="#symbol-vs.-filled-maps">Symbol vs.&nbsp;Filled Maps</a>
  <ul class="collapse">
  <li><a href="#symbol-maps" id="toc-symbol-maps" class="nav-link" data-scroll-target="#symbol-maps">Symbol Maps</a></li>
  <li><a href="#filled-maps" id="toc-filled-maps" class="nav-link" data-scroll-target="#filled-maps">Filled Maps</a></li>
  <li><a href="#knowledge-checks" id="toc-knowledge-checks" class="nav-link" data-scroll-target="#knowledge-checks">Knowledge Checks</a></li>
  </ul></li>
  <li><a href="#geocoding-application" id="toc-geocoding-application" class="nav-link" data-scroll-target="#geocoding-application">Geocoding Application</a>
  <ul class="collapse">
  <li><a href="#creating-a-symbol-map" id="toc-creating-a-symbol-map" class="nav-link" data-scroll-target="#creating-a-symbol-map">1. Creating a Symbol Map</a></li>
  <li><a href="#creating-a-filled-map" id="toc-creating-a-filled-map" class="nav-link" data-scroll-target="#creating-a-filled-map">2. Creating a Filled Map</a></li>
  </ul></li>
  <li><a href="#on-your-own-plotting-results-from-a-cluster-analysis" id="toc-on-your-own-plotting-results-from-a-cluster-analysis" class="nav-link" data-scroll-target="#on-your-own-plotting-results-from-a-cluster-analysis">On Your Own: Plotting Results from a Cluster Analysis</a>
  <ul class="collapse">
  <li><a href="#extra-feature-in-tableau-customizing-your-map" id="toc-extra-feature-in-tableau-customizing-your-map" class="nav-link" data-scroll-target="#extra-feature-in-tableau-customizing-your-map">Extra Feature in Tableau: Customizing Your Map</a></li>
  </ul></li>
  </ul></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Week 10 Lab: Visualizing and Exploring Cross-Sectional Data in Tableau</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p><img src="includes/cross-sectional.png" class="img-fluid"></p>
<div style="font-size: 1.5em">
<p>This Lab Contributes to Course Objectives: 1, 3, 4, 5, 7, 8</p>
</div>
<section id="learning-objectives-r" class="level2">
<h2 class="anchored" data-anchor-id="learning-objectives-r">Learning Objectives: R</h2>
<ul>
<li><p>Practice joining and cleaning cross-sectional datasets</p></li>
<li><p>Create store-level summaries</p></li>
<li><p>Visualize and explore store attributes</p></li>
<li><p>Log-transform and scale variables</p></li>
<li><p>Apply k-means clustering and interpret results</p></li>
</ul>
</section>
<section id="learning-objectives-tableau" class="level2">
<h2 class="anchored" data-anchor-id="learning-objectives-tableau">Learning Objectives: Tableau</h2>
<ul>
<li><p>Understand Tableau geocoding capabilities</p></li>
<li><p>Explain the different use cases of symbol and filled maps</p></li>
<li><p>Create symbol and filled maps</p></li>
<li><p>Customize Tableau maps</p></li>
<li><p>Aggregate individual-level data by geographic region</p></li>
</ul>
</section>
<section id="download-lab-handout-here" class="level2">
<h2 class="anchored" data-anchor-id="download-lab-handout-here"><a href="project_02_helper.pdf">Download Lab Handout Here</a></h2>
<embed src="project_02_helper.pdf" width="100%" height="600px" type="application/pdf">
</section>
<section id="part-1-r" class="level1">
<h1>Part 1: R</h1>
<p>We’ll use store-level data to group similar stores into <strong>clusters</strong> using k-means clustering. This process will help us segment stores based on customer behavior and sales performance.</p>
<section id="step-1-set-working-directory-and-load-packages" class="level2">
<h2 class="anchored" data-anchor-id="step-1-set-working-directory-and-load-packages">Step 1: Set Working Directory and Load Packages</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Set your working directory</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">setwd</span>(<span class="st">"C:/Your/File/Path/Here"</span>)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">getwd</span>()</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Load libraries using pacman</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="co"># pacman installs and loads the required packages</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="co"># install.packages("pacman")</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(pacman)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="fu">p_load</span>(dplyr,readr,tidyverse,ggplot2,modelsummary,GGally,factoextra,pandoc)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-2-read-in-and-inspect-the-data" class="level2">
<h2 class="anchored" data-anchor-id="step-2-read-in-and-inspect-the-data">Step 2: Read in and Inspect the Data</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>shopper_info <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"https://csu-arec-330.github.io/materials/unit_02/inputs/shopper_info.csv"</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>gtin <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"https://csu-arec-330.github.io/materials/unit_02/inputs/gtin.csv"</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>store_info <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"https://csu-arec-330.github.io/materials/unit_02/inputs/store_info.csv"</span>)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(shopper_info)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(gtin)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(store_info)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-important callout-titled" title="Check Your Understanding">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Check Your Understanding
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><p>How many rows and columns are in each dataset?</p></li>
<li><p>What are the variables that link each table together? Go back to <a href="../week_01/lab_02_week_01.qmd">Lab 09</a> to review the data dictionary.</p></li>
</ul>
</div>
</div>
</section>
<section id="step-3-join-the-data" class="level2">
<h2 class="anchored" data-anchor-id="step-3-join-the-data">Step 3: Join the Data</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>store_shopper_left <span class="ot">&lt;-</span> <span class="fu">left_join</span>(store_info, shopper_info, <span class="at">by =</span> <span class="st">"store_id"</span>)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>store_shopper_gtin_left <span class="ot">&lt;-</span> <span class="fu">left_join</span>(store_shopper_left, gtin, <span class="at">by =</span> <span class="st">"gtin"</span>)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co"># How many observations do we have after each join?</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="fu">nrow</span>(store_shopper_left)</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="fu">nrow</span>(store_shopper_gtin_left)</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(<span class="fu">unique</span>(store_shopper_gtin_left<span class="sc">$</span>store_id))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-important callout-titled" title="Challenge Question">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Challenge Question
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><p>Why do we use <code>left_join()</code> here instead of <code>inner_join()</code>?</p></li>
<li><p>What does it mean if a store has no matching transactions?</p></li>
</ul>
</div>
</div>
</section>
<section id="step-4-clean-the-data" class="level2">
<h2 class="anchored" data-anchor-id="step-4-clean-the-data">Step 4: Clean the Data</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>clean_data <span class="ot">&lt;-</span> store_shopper_gtin_left <span class="sc">%&gt;%</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(unit_price <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(shopper_id)) <span class="sc">%&gt;%</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">total =</span> unit_price <span class="sc">*</span> unit_quantity) <span class="sc">%&gt;%</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(store_id, zip_code)</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(<span class="fu">unique</span>(clean_data<span class="sc">$</span>store_id))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-important callout-titled" title="Why This Matters">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Why This Matters
</div>
</div>
<div class="callout-body-container callout-body">
<p>We remove negative or zero prices (likely errors), and keep fuel purchases (<code>gtin</code> = <code>NA</code> and <code>gtin</code> = <code>0</code>) because they tell us something about store type.</p>
</div>
</div>
</section>
<section id="step-5-create-store-level-summary" class="level2">
<h2 class="anchored" data-anchor-id="step-5-create-store-level-summary">Step 5: Create Store-Level Summary</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>store_summary <span class="ot">&lt;-</span> clean_data <span class="sc">%&gt;%</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(store_id) <span class="sc">%&gt;%</span>  <span class="co"># Group the data by store</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">total_sales =</span> <span class="fu">sum</span>(unit_price <span class="sc">*</span> unit_quantity, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),         <span class="co"># Total sales across all transactions</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">unique_customers =</span> <span class="fu">n_distinct</span>(shopper_id),                           <span class="co"># Number of unique shoppers</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">product_diversity =</span> <span class="fu">n_distinct</span>(gtin),                                <span class="co"># Number of unique products sold</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">fuel_transactions =</span> <span class="fu">sum</span>(<span class="fu">is.na</span>(gtin) <span class="sc">|</span> gtin <span class="sc">==</span> <span class="dv">0</span>),                    <span class="co"># Count of fuel transactions (gtin is NA or 0)</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">total_transactions =</span> <span class="fu">n_distinct</span>(transaction_set_id),                <span class="co"># Total number of transactions (visits)</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">fuel_share =</span> fuel_transactions <span class="sc">/</span> total_transactions,                <span class="co"># Share of transactions that are fuel-only</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span>                                                    <span class="co"># Drop grouping structure from output</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(store_info <span class="sc">%&gt;%</span> <span class="fu">select</span>(store_id, chain_size), <span class="at">by =</span> <span class="st">"store_id"</span>) <span class="sc">%&gt;%</span>  <span class="co"># Add chain size from store_info</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(chain_size))  <span class="co"># Keep only rows with valid chain_size (required for clustering later)</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge store summary with the full store_info (excluding duplicate chain_size column)</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>final_dataset <span class="ot">&lt;-</span> store_summary <span class="sc">%&gt;%</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(store_info <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span>chain_size), <span class="at">by =</span> <span class="st">"store_id"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(store_id, zip_code)  <span class="co"># Arrange for easier viewing</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a><span class="fu">View</span>(final_dataset)  <span class="co"># Inspect the final dataset of store-level characteristics</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-important callout-titled" title="Check Your Understanding">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Check Your Understanding
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><p>What does <code>fuel_share</code> tell us about store specialization?</p></li>
<li><p>How many stores do we have in the final dataset?</p></li>
</ul>
</div>
</div>
</section>
<section id="step-6-generate-summary-statistics" class="level2">
<h2 class="anchored" data-anchor-id="step-6-generate-summary-statistics">Step 6: Generate Summary Statistics</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">datasummary_skim</span>(final_dataset, <span class="at">type =</span> <span class="st">"numeric"</span>)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="fu">datasummary_skim</span>(final_dataset, <span class="at">type =</span> <span class="st">"categorical"</span>)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="fu">datasummary</span>(unique_customers <span class="sc">+</span> total_sales <span class="sc">+</span> product_diversity <span class="sc">+</span> fuel_share <span class="sc">+</span> chain_size <span class="sc">~</span> Mean <span class="sc">+</span> SD <span class="sc">+</span> Min <span class="sc">+</span> Max,</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">data=</span>final_dataset,</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>            <span class="at">output =</span> <span class="st">"sumstats.docx"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-7-visualize-relationships" class="level2">
<h2 class="anchored" data-anchor-id="step-7-visualize-relationships">Step 7: Visualize Relationships</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>final_dataset <span class="sc">%&gt;%</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(unique_customers, total_sales, product_diversity, fuel_share, chain_size) <span class="sc">%&gt;%</span> </span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggpairs</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-important callout-titled" title="Why This Matters">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Why This Matters
</div>
</div>
<div class="callout-body-container callout-body">
<p>The ggpairs plot shows skewed distributions and correlations. Skewed data can distort clustering results, so we’ll log-transform</p>
</div>
</div>
</section>
<section id="step-8-log-transform-skewed-variables" class="level2">
<h2 class="anchored" data-anchor-id="step-8-log-transform-skewed-variables">Step 8: Log-Transform Skewed Variables</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>final_dataset <span class="ot">&lt;-</span> final_dataset <span class="sc">%&gt;%</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">log_customers =</span> <span class="fu">log</span>(unique_customers <span class="sc">+</span> <span class="dv">1</span>),</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">log_sales =</span> <span class="fu">log</span>(total_sales <span class="sc">+</span> <span class="dv">1</span>),</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">log_products =</span> <span class="fu">log</span>(product_diversity <span class="sc">+</span> <span class="dv">1</span>),</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">log_chain_size =</span> <span class="fu">log</span>(chain_size <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Re-check with ggpairs</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>final_dataset <span class="sc">%&gt;%</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(log_customers, log_sales, log_products, fuel_share, log_chain_size) <span class="sc">%&gt;%</span> </span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggpairs</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-9-cluster-analysis" class="level2">
<h2 class="anchored" data-anchor-id="step-9-cluster-analysis">Step 9: Cluster Analysis</h2>
<p><strong>1. Scale the Data</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check for NAs Before Scaling</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>final_dataset <span class="sc">%&gt;%</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(log_customers, log_sales, log_products, fuel_share, log_chain_size) <span class="sc">%&gt;%</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="fu">across</span>(<span class="fu">everything</span>(), <span class="sc">~</span> <span class="fu">sum</span>(<span class="fu">is.na</span>(.))))</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Scale the Data</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>cluster_data <span class="ot">&lt;-</span> final_dataset <span class="sc">%&gt;%</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(log_customers, log_sales, log_products, fuel_share, log_chain_size) <span class="sc">%&gt;%</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">drop_na</span>()</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>cluster_scaled <span class="ot">&lt;-</span> <span class="fu">scale</span>(cluster_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>2. Determine the Optimal Number of Clusters</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Use Elbow and Silhouette Methods to determine optimal number of clusters</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="fu">fviz_nbclust</span>(cluster_scaled, kmeans, <span class="at">method =</span> <span class="st">"silhouette"</span>)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="fu">fviz_nbclust</span>(cluster_scaled, kmeans, <span class="at">method =</span> <span class="st">"wss"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-important callout-titled" title="Challenge Question">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Challenge Question
</div>
</div>
<div class="callout-body-container callout-body">
<p>What number of clusters seems most appropriate based on the plots? Why?</p>
</div>
</div>
<p><strong>3. Run K-Means</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>kmeans_fit <span class="ot">&lt;-</span> <span class="fu">kmeans</span>(cluster_scaled, <span class="at">centers =</span> <span class="dv">4</span>, <span class="at">nstart =</span> <span class="dv">25</span>)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>final_clusters <span class="ot">&lt;-</span> final_dataset <span class="sc">%&gt;%</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">cluster =</span> kmeans_fit<span class="sc">$</span>cluster)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>4. Compare Cluster Averages</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Use the original (non-logged) variables because you're summarizing actual store characteristics — not the transformed versions.</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>final_clusters <span class="sc">%&gt;%</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(cluster) <span class="sc">%&gt;%</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="fu">across</span>(<span class="fu">c</span>(unique_customers, total_sales, product_diversity, fuel_share, chain_size), mean))</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="fu">View</span>(final_clusters)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-important callout-titled" title="Why This Matters">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Why This Matters
</div>
</div>
<div class="callout-body-container callout-body">
<p><code>log_sales</code>, <code>log_customers</code>, etc., were only used to improve the clustering algorithm (by reducing skew and balancing scales). But once the clustering is done, you want to describe the real characteristics of each cluster in interpretable units.</p>
</div>
</div>
</section>
<section id="step-10-what-do-your-clusters-reveal" class="level2">
<h2 class="anchored" data-anchor-id="step-10-what-do-your-clusters-reveal">Step 10: What Do Your Clusters Reveal?</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>most_frequent_purchase <span class="ot">&lt;-</span> store_info <span class="sc">%&gt;%</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(final_clusters <span class="sc">%&gt;%</span> <span class="fu">select</span>(store_id, cluster), <span class="at">by =</span> <span class="st">"store_id"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(cluster)) <span class="sc">%&gt;%</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(shopper_info, <span class="at">by =</span> <span class="st">"store_id"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(gtin, <span class="at">by =</span> <span class="st">"gtin"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(cluster, gtin, subcategory) <span class="sc">%&gt;%</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(subcategory)) <span class="sc">%&gt;%</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">purchase_count =</span> <span class="fu">n</span>(), <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(cluster) <span class="sc">%&gt;%</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(purchase_count <span class="sc">==</span> <span class="fu">max</span>(purchase_count)) <span class="sc">%&gt;%</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>gtin)</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a><span class="fu">View</span>(most_frequent_purchase)</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Join most_frequent_purchase with final_clusters and then write to csv</span></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>final_clusters_out <span class="ot">&lt;-</span> final_clusters <span class="sc">%&gt;%</span></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(most_frequent_purchase, <span class="at">by =</span> <span class="st">"cluster"</span>)</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a><span class="fu">write_csv</span>(final_clusters_out, <span class="st">"final_clusters_out.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-important callout-titled" title="Check Your Understanding">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Check Your Understanding
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><p>What is the most common product category in each cluster?</p></li>
<li><p>How might this help a convenience store manager?</p></li>
</ul>
</div>
</div>
</section>
</section>
<section id="part-2-tableau" class="level1">
<h1>Part 2: Tableau</h1>
<p>The defining characteristic of cross-sectional data is that we observe values of variables at a single point in, or cross-section of, time. Often, but not always, cross-sectional data have geographic components that allows us to use Tableau’s mapping features when creating visualizations.</p>
<p>Effective analysis of cross-sectional data begins with estimating and conveying useful summary statistics. Today, we will spend most of our time discussing how to do this with spatial data.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-1-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-1" role="tab" aria-controls="tabset-1-1" aria-selected="true" href="">Tableau’s Geocoding</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-2" role="tab" aria-controls="tabset-1-2" aria-selected="false" href="">Tableau’s Spatial Data Capabilities</a></li></ul>
<div class="tab-content">
<div id="tabset-1-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-1-1-tab">
<p>If you want to analyze your data geographically, you can plot your data on a map in Tableau.</p>
<p>When building map views, Tableau supports any latitude and longitude coordinates, as long as they are in decimal degrees. Tableau can also recognize and geocode the following geographic information types:</p>
<ul>
<li><p>Airport Codes</p></li>
<li><p>Cities</p></li>
<li><p>Countries</p></li>
<li><p>Regions</p></li>
<li><p>Territories</p></li>
<li><p>States</p></li>
<li><p>Provinces</p></li>
<li><p>Postcodes</p></li>
<li><p>Core Based Statistical Areas (CBSAs)</p></li>
<li><p>Metropolitan Statistical Areas (MSAs)</p></li>
<li><p>U.S. Area Codes</p></li>
<li><p>Congressional Districts</p></li>
<li><p>Zip Codes</p></li>
</ul>
<p>If you have geographic delineations besides these, you will have to use crosswalks or some other means to convert the delineations to one of these forms, or to generate latitudes and longitudes for specific points (e.g., addresses).</p>
</div>
<div id="tabset-1-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-2-tab">
<p>Tableau can also connect to the following spatial file types:</p>
<ul>
<li><p>Shapefiles</p></li>
<li><p>KML files</p></li>
<li><p>GeoJSON files</p></li>
<li><p>TopoJSON files</p></li>
<li><p>Esri File Geodatabases</p></li>
</ul>
<p>These types of files include detailed geographic information that enables us to plot shapes and single points.</p>
</div>
</div>
</div>
<section id="symbol-vs.-filled-maps" class="level2">
<h2 class="anchored" data-anchor-id="symbol-vs.-filled-maps">Symbol vs.&nbsp;Filled Maps</h2>
<section id="symbol-maps" class="level3">
<h3 class="anchored" data-anchor-id="symbol-maps">Symbol Maps</h3>
<p>A symbol map visualizes quantitative data across geographic locations and is particularly effective for displaying variations or patterns across different areas. This type of map can highlight individual store locations, distribution points, or any geographical data point associated with numeric values.</p>
<p><img src="includes/Sheet1.png" class="img-fluid"> You might want to highlight which stores have higher spending <a href="https://www.safegraph.com/data-examples/ohio-grocery-spend">like this example</a>.</p>
<section id="data-requirements-for-symbol-maps" class="level4">
<h4 class="anchored" data-anchor-id="data-requirements-for-symbol-maps">Data Requirements for Symbol Maps</h4>
<p>To create a symbol map in Tableau, your data source must include:</p>
<ol type="1">
<li><p><strong>Quantitative Values</strong>: Numeric data that you want to visualize (e.g., sales volume, customer count). These values will determine the size or color of the symbols on the map.</p></li>
<li><p><strong>Geographic Information</strong>: Latitude and longitude coordinates are preferred for precision. However, Tableau can also recognize and plot data using geographic locations (e.g., city names, postal codes, country names) provided they are correctly formatted.</p></li>
</ol>
</section>
<section id="steps-to-create-a-symbol-map-in-tableau" class="level4">
<h4 class="anchored" data-anchor-id="steps-to-create-a-symbol-map-in-tableau">Steps to Create a Symbol Map in Tableau</h4>
<ol type="1">
<li><p>Connect Your Data: Start Tableau and connect to your data source.</p></li>
<li><p>Prepare Your Data: Ensure your geographic fields (e.g., latitude and longitude) are recognized by Tableau. If necessary, you might need to set the geographic role of your fields by right-clicking the field name in the Data pane and selecting “Geographic Role.”</p></li>
<li><p>Create the Map: Drag your geographic field to the Rows or Columns shelf. Tableau automatically creates a map view. If using latitude and longitude, drag them to the respective shelves.</p></li>
<li><p>Add Your Data Layer: Drag the field representing your quantitative values to the “Size” mark or “Color” mark in the Marks card. Adjust the size and color to reflect the data accurately.</p></li>
<li><p>Customize Your Map: Use the “Map” menu to adjust the map’s background, borders, and labels for better readability and impact. Consider adding filters or additional layers for interactivity and deeper analysis.</p></li>
</ol>
<div class="callout callout-style-default callout-note callout-titled" title="Tips for Effective Symbol Maps">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tips for Effective Symbol Maps
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><p>Variation in Values: Symbol maps are most impactful when there’s significant variation in the quantitative values being represented. If your data points have similar values, consider using color gradients instead of size to represent the data, as slight differences in color can be more discernible.</p></li>
<li><p>Symbol Size and Overlap: Adjust the size of your symbols to ensure they are visible and do not overlap excessively, especially in areas with many data points. Tableau allows you to scale the size of symbols based on the view or to set fixed sizes.</p></li>
<li><p>Annotations and Tooltips: Enhance your map with annotations to highlight key locations or trends. Customize tooltips to provide additional information about each symbol when hovered over.</p></li>
<li><p>Legends and Labels: Ensure your map includes a clear legend for size and color indicators. Use labels sparingly to maintain map clarity, focusing on major points of interest.</p></li>
</ul>
</div>
</div>
</section>
</section>
<section id="filled-maps" class="level3">
<h3 class="anchored" data-anchor-id="filled-maps">Filled Maps</h3>
<p>Filled maps, also known as choropleth maps, are powerful visual tools for displaying how quantitative or qualitative values vary across geographic regions. They color-code regions (such as countries, states, or counties) based on the data values they represent, making it easy to see relative differences in data distribution spatially. For instance, to analyze and compare rental rates across Colorado counties, a filled map provides a clear visual representation of spatial comparisons.</p>
<p><img src="includes/Sheet3.png" class="img-fluid"></p>
<section id="data-requirements-for-filled-maps" class="level4">
<h4 class="anchored" data-anchor-id="data-requirements-for-filled-maps">Data Requirements for Filled Maps</h4>
<p>To create an effective filled map in Tableau, your data source must include:</p>
<ol type="1">
<li><p><strong>Quantitative or Qualitative Values</strong>: These values determine the color intensity of each geographic region on the map. Quantitative data could be numerical values like population size or average income, while qualitative data could include categorical values that are ranked or ordered.</p></li>
<li><p><strong>Geographic Locations</strong>: The data must contain geographic location information that Tableau recognizes (e.g., country names, state names, postal codes). For more specific or customized geographic areas, such as electoral districts, you may need custom polygons provided by spatial data files (e.g., Shapefiles).</p></li>
</ol>
</section>
<section id="steps-to-create-a-filled-map-in-tableau" class="level4">
<h4 class="anchored" data-anchor-id="steps-to-create-a-filled-map-in-tableau">Steps to Create a Filled Map in Tableau</h4>
<ol type="1">
<li><p>Prepare Your Data: Ensure geographic location fields in your dataset are correctly identified by Tableau. You may need to set or verify the geographic role for these fields in the Data pane.</p></li>
<li><p>Drag and Drop to Create the Map: Double-click on the geographic field in your data pane. Tableau automatically creates a map based on the location data.</p></li>
<li><p>Encode Data with Color: Drag the field representing the values you wish to visualize onto the “Color” mark on the Marks card. Tableau will apply a color scheme to the map regions based on these values.</p></li>
<li><p>Adjust Color Palette: Customize the color palette to enhance readability and effectively communicate the data story. Use diverging color schemes for qualitative data and sequential schemes for quantitative data.</p></li>
<li><p>Refine and Customize: Use the “Map” options to adjust map features, such as borders and labels. Add legends, annotations, and tooltips to make your map more informative and interactive.</p></li>
</ol>
<div class="callout callout-style-default callout-note callout-titled" title="Tips for Effective Filled Maps">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tips for Effective Filled Maps
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><p>Choose the Right Data: Filled maps are best suited for data that varies across defined geographic regions. Ensure your data is appropriate for this type of visualization, focusing on regional differences or patterns.</p></li>
<li><p>Simplify for Clarity: Avoid overloading your map with too much data or too many categories. If your map becomes too cluttered, consider simplifying the data or using filters to allow viewers to focus on specific aspects.</p></li>
<li><p>Use Color Wisely: Select color palettes that are easy to read and interpret. Use sequential colors for quantitative data to show a gradient of values, and diverging colors for data with a critical midpoint.</p></li>
<li><p>Highlight Important Data: Use annotations or focused color highlights to draw attention to significant areas or patterns you want to emphasize, such as regions with exceptionally high or low values.</p></li>
<li><p>Consider Geographic Scale: The chosen geographic scale can impact the interpretation of your data. Be mindful of how zoom level and regional boundaries influence the perception of data distribution and density.</p></li>
</ul>
</div>
</div>
</section>
</section>
<section id="knowledge-checks" class="level3">
<h3 class="anchored" data-anchor-id="knowledge-checks">Knowledge Checks</h3>
<p>Knowledge Check 1: Suppose we have gas station-level data on gas prices yesterday. What type of map would you use to show this information?</p>
<blockquote class="blockquote">
<p>For gas station-level data on gas prices yesterday, a <strong>symbol map</strong> would be more appropriate. It would let you place symbols at each gas station’s location, with symbol sizes or colors representing the price of gas, providing detailed location-specific price information.</p>
</blockquote>
<p>Knowledge Check 2: Suppose we have county-level data on average gas prices last year. What type of map would you use to show this information?</p>
<blockquote class="blockquote">
<p>For county-level data on average gas prices last year, a <strong>filled map</strong> would be the most suitable choice. It would allow you to color-code each county based on the average gas price, showing spatial variations across the region.</p>
</blockquote>
</section>
</section>
<section id="geocoding-application" class="level2">
<h2 class="anchored" data-anchor-id="geocoding-application">Geocoding Application</h2>
<section id="creating-a-symbol-map" class="level3">
<h3 class="anchored" data-anchor-id="creating-a-symbol-map">1. Creating a Symbol Map</h3>
<ol type="1">
<li><p>Connect to <code>final_clusters_out.csv</code>: Start Tableau and connect to the dataset.</p></li>
<li><p>Prepare the Data: Check that <code>Longitude</code> and <code>Latitude</code> are recognized by Tableau as geographic fields. If not, set their geographic roles appropriately by right-clicking each field in the Data pane and selecting Geographic Role &gt; Longitude or Latitude.</p></li>
<li><p>Drag Longitude and Latitude: Move the <code>Longitude</code> field to the Columns Shelf and the <code>Latitude</code> field to the Rows Shelf to initiate the creation of a map. If Tableau does not automatically recognize them as geographic fields, you might need to change their data type to dimensions.</p></li>
</ol>
<!-- > Note: This file is a very very VERY small slice of cell phone visit data from the company [Safegraph](https://www.safegraph.com). The slice includes all grocery retail stores in Arizona with a sufficiently large number of visitors in September of 2021. Visitors (including you if you happened to be in Arizona at that time...) are tracked via their cell phones. The data includes information on the store (name, location, NAICS code, etc.), the number of visits, visitors (unique cell phones), the median distance traveled to shop there, and the median amount of time spent there. -->
<ol start="4" type="1">
<li><p>Visualize Store Types: To explore the variety of chain stores, drag the <code>store_chain_name</code> field onto the Color card. This action will color-code the map symbols according to the type of chain store, allowing you to quickly see which category is most prevalent across the dataset.</p></li>
<li><p>Analyze Visitor Counts: To understand the popularity of these stores, drag the <code>unique_customers</code> field onto the Size card. This will adjust the size of each symbol on the map based on the number of unique shoppers, making it easy to identify which stores attract the most visitors.</p></li>
<li><p>Enhance Tooltips: For more detailed information about each store, add the <code>store_name</code> to the Tooltip card. This ensures that when you hover over any symbol on the map, you can see the store’s name along with other data you’ve chosen to include.</p></li>
</ol>
<section id="you-do-it-create-a-new-symbol-map" class="level4">
<h4 class="anchored" data-anchor-id="you-do-it-create-a-new-symbol-map">You Do It: Create a New Symbol Map</h4>
<p>Let’s create a symbol map using the provided latitudes and longitudes of these stores.</p>
<ol type="1">
<li><p>Drag <code>Longitude</code> to the Columns Shelf and <code>Latitude</code> to the Rows Shelf. (You will likely have to change these fields to <code>Dimensions</code>)</p></li>
<li><p>Drag <code>store_chain_name</code> to the colors card.</p></li>
</ol>
<p>Which type of store appears to be the most prevalent?</p>
<ol start="3" type="1">
<li>Now, let’s drag <code>unique_customers</code> to the size card.</li>
</ol>
<p>Which type of store appears to have the most visitors?</p>
<ol start="4" type="1">
<li><p>Now, let’s add each store’s name to the tooltip. Drag <code>Location Name</code> to the Tooltip card.</p></li>
<li><p>Make a new symbol map using each store’s latitude and longitude, and choosing what information you want to include as colors, size, and in the tooltip. What did you uncover?</p></li>
</ol>
<blockquote class="blockquote">
<p>what happens if we select a different geographical field to make our map? Select the fields <code>City</code> and <code>unique_customers</code> and select the Symbol Map in the Show Me Menu. What is this map showing?</p>
</blockquote>
<blockquote class="blockquote">
<p>What if we change the aggregation of <code>unique_customers</code> to average instead of sum?</p>
</blockquote>
<p>::: {.callout-note title=“Other Options for Creating Symbol Maps} 1. Follow the initial steps to set up another symbol map. This time, experiment with different attributes for colors, size, and tooltips. For instance, you might choose to visualize the <strong>product diversity</strong> using the size of the symbols, or the <strong>chain size</strong> as the color.</p>
<ol start="2" type="1">
<li><p>Instead of using precise longitude and latitude, try creating a map based on <code>City</code> and associate it with <code>unique_customers</code> by dragging <code>City</code> to the Columns Shelf and <code>unique_customers</code> to the Rows Shelf. Use the Show Me menu to select Symbol Map. This visualization will provide a more aggregated view, showing visitor counts per city.</p></li>
<li><p>Modify the aggregation of <code>unique_customers</code> from sum to average by right-clicking on the field in the Marks card and choosing Measure(Sum) &gt; Average. This adjustment shows the average number of visits per store within each city or map symbol, offering insights into typical store performance rather than total visits. :::</p></li>
</ol>
</section>
</section>
<section id="creating-a-filled-map" class="level3">
<h3 class="anchored" data-anchor-id="creating-a-filled-map">2. Creating a Filled Map</h3>
<p>Filled maps provide a powerful way to visualize data that varies across geographic regions, using color to represent the intensity or magnitude of a variable within predefined areas like postal codes, counties, or countries. Let’s apply this to our cell phone data.</p>
<ol type="1">
<li><p>Select the <code>zip_code</code> and move it to the Columns Shelf, and <code>unique_customers</code> and move it to the Rows Shelf.</p></li>
<li><p>Navigate to the Show Me Menu; you should have the option to select either a symbol map or a filled map. Choose the filled map.</p></li>
<li><p>Analyze the Visualization:</p></li>
</ol>
<ul>
<li><p>Understanding the Map: This map colors each postal code area based on the <code>unique_customers</code>, showing where grocery stores receive higher or lower volumes of traffic.</p></li>
<li><p>Multiple Attributes: While filled maps are excellent for visualizing one main attribute per geographic area, layering multiple store attributes directly on the map might be challenging.</p></li>
<li><p>Add Store Information: To provide context on the types of stores within each postal code, drag the <code>store_chain_name</code> field into the Tooltip editor. Use the Insert button in the editor or type in the field name surrounded by <code>&lt; &gt;</code>, like <code>&lt;store_chain_name&gt;</code>.</p></li>
</ul>
<p>Does the symbol map or filled map provide a clearer understanding of the data?</p>
<blockquote class="blockquote">
<p>Filled maps are great for showing density or intensity over areas, while symbol maps are better for exact locations and attributes of individual points.</p>
</blockquote>
<section id="you-do-it-combine-symbol-and-filled-maps" class="level4">
<h4 class="anchored" data-anchor-id="you-do-it-combine-symbol-and-filled-maps">You Do It: Combine Symbol and Filled Maps</h4>
<ol type="1">
<li><p>In your Tableau workspace with the cell phone data, create a new worksheet.</p></li>
<li><p>Show unique customers by postal code using a filled map.</p></li>
<li><p>Copy Latitude Measure: Command-click (Mac) or Control-click (Windows) the <code>Latitude</code> measure on the Rows shelf and drag it to the right to duplicate it.</p></li>
<li><p>Adjust Marks Card: For the second map pane, remove the <code>Postal Code</code> field. Then, drag both the <code>Latitude</code> and <code>Longitude</code> fields to the Details card on the Marks card.</p></li>
<li><p>Customize with Data: Add <code>store_chain_name</code> to the Color card to differentiate store types and <code>product_diversity</code> (or choose something else that you think works) to the Size card to represent differences across product mix.</p></li>
<li><p>Enable Dual Axes: Right-click the second <code>Latitude</code> field on the Rows shelf and choose Dual Axis.</p></li>
<li><p>Finalize Formatting: Apply any additional custom formatting to your map as desired.</p></li>
</ol>
<blockquote class="blockquote">
<p><strong>Interpretation</strong>: This combined map offers a comprehensive view of customer behavior, highlighting areas with high visit counts and distinguishing stores by chain and product mix. It allows for spatial analysis of store popularity and accessibility, providing valuable insights into consumer preferences and mobility patterns.</p>
</blockquote>
</section>
</section>
</section>
<section id="on-your-own-plotting-results-from-a-cluster-analysis" class="level2">
<h2 class="anchored" data-anchor-id="on-your-own-plotting-results-from-a-cluster-analysis">On Your Own: Plotting Results from a Cluster Analysis</h2>
<p>If you want to show results from your cluster analysis in Tableau, a simple way is to associate each cluster with a specific color. Let’s do this now.</p>
<ol type="1">
<li><p>Connect to the dataset with the results from the store-level cluster analysis (<code>final_clusters_out.csv</code>).</p></li>
<li><p>Select <code>Latitude</code>, <code>Longitude</code>, and <code>Cluster</code> and select the Symbol Map from <code>Show Me</code>.</p></li>
<li><p>Recall you will need to change the <code>Latitude</code> and <code>Longitude</code> fields to Dimensions for this to display correctly.</p></li>
<li><p>Let’s also change <code>Cluster</code> to be associated with a color (rather than size) by dragging it to the <code>Color</code> card.</p></li>
<li><p>Finally, let’s change <code>Cluster</code> to a Dimension and tell Tableau that it is Discrete.</p></li>
<li><p>Let’s add some more detail to the tooltip. I would like to know the location name, store chain name, and cluster when I hover over each point on the map.</p></li>
</ol>
<section id="extra-feature-in-tableau-customizing-your-map" class="level3">
<h3 class="anchored" data-anchor-id="extra-feature-in-tableau-customizing-your-map">Extra Feature in Tableau: Customizing Your Map</h3>
<p>Tableau offers powerful customization options for maps, including background layers and integrated data sources. Follow these specific steps to enhance your map and explore a combination of symbol and filled map layers.</p>
<ol type="1">
<li>Adding Background Layers</li>
</ol>
<ul>
<li><p>Access Background Layers: Right-click on your map and select <code>Background Layers...</code>.</p></li>
<li><p>Explore Layer Options: Browse through the map layer options and select a combination that enhances the readability and appeal of your map.</p></li>
</ul>
<ol start="2" type="1">
<li>Integrating Data Sources</li>
</ol>
<ul>
<li><p>Select Integrated Data Source: Click the drop-down menu under to <code>Data Layer</code> and choose one of Tableau’s integrated data sources.</p></li>
<li><p>Adjust Geographic Level: Change the geographic level at which this information is displayed, tailoring it to the scale of your analysis.</p></li>
</ul>
<div class="quarto-video ratio ratio-16x9"><iframe data-external="1" src="https://www.youtube.com/embed/lXloWsi7hZQ" title="" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></div>
<p>Note: This video uses a different dataset than in our lab, however, it is helpful to see Tableau’s functionality in practice.</p>
</section>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>